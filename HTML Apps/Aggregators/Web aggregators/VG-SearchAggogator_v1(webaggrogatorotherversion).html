<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Aggregator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-white dark:bg-gray-900 min-h-screen">
    <div class="container mx-auto p-4 max-w-7xl">
        <!-- Top Controls -->
        <div class="flex justify-end gap-2 mb-4">
            <button id="saveState" class="p-2 text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition-colors" title="Save State">
                <i class="fas fa-save text-lg"></i>
            </button>
            <button id="importState" class="p-2 text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition-colors" title="Import State">
                <i class="fas fa-upload text-lg"></i>
            </button>
            <button id="downloadFlow" class="p-2 text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition-colors" title="Download All Responses">
                <i class="fas fa-download text-lg"></i>
            </button>
            <button id="clearState" class="p-2 text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition-colors" title="Clear State">
                <i class="fas fa-eraser text-lg"></i>
            </button>
        </div>

        <!-- Import State Modal -->
        <div id="importModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-2xl w-full mx-4">
                <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-4">Import State</h3>
                <textarea 
                    id="stateInput" 
                    class="w-full h-64 p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-sm font-mono resize-none focus:outline-none focus:ring-2 focus:ring-primary" 
                    placeholder="Paste your JSON state here..."
                ></textarea>
                <div class="flex justify-end gap-3 mt-4">
                    <button id="cancelImport" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors">Cancel</button>
                    <button id="loadState" class="px-4 py-2 bg-primary text-white hover:bg-opacity-90 rounded transition-colors">Load State</button>
                </div>
            </div>
        </div>

        <!-- Input Section -->
        <div class="mb-6">
            <div class="flex gap-2">
                <textarea 
                    id="promptInput" 
                    class="flex-1 p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 text-base focus:outline-none focus:ring-2 focus:ring-primary resize-none" 
                    rows="3" 
                    placeholder="Enter your prompt here..."
                ></textarea>
                <button 
                    id="sendButton" 
                    class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors font-medium"
                >
                    Send
                </button>
            </div>
        </div>

        <!-- Response Boxes -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-6">
            <div class="response-box" data-index="0">
                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 h-80 flex flex-col">
                    <div class="flex items-center gap-2 mb-3">
                        <select class="model-select flex-1 p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-sm">
                            <option value="">Select Model</option>
                        </select>
                        <button class="clear-response-btn p-2 text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition-colors" title="Clear this response">
                            <i class="fas fa-eraser text-sm"></i>
                        </button>
                    </div>
                    <div class="flex-1 overflow-auto mb-3">
                        <div class="response-content text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap"></div>
                    </div>
                    <div class="flex gap-2">
                        <button class="preview-btn flex-1 px-3 py-1 bg-primary text-white rounded text-xs hover:bg-opacity-90" title="Preview">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="copy-btn px-3 py-1 bg-gray-500 text-white rounded text-xs hover:bg-opacity-90">Copy</button>
                        <button class="download-btn px-3 py-1 bg-green-500 text-white rounded text-xs hover:bg-opacity-90">Download</button>
                    </div>
                </div>
            </div>
            <div class="response-box" data-index="1">
                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 h-80 flex flex-col">
                    <div class="flex items-center gap-2 mb-3">
                        <select class="model-select flex-1 p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-sm">
                            <option value="">Select Model</option>
                        </select>
                        <button class="clear-response-btn p-2 text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition-colors" title="Clear this response">
                            <i class="fas fa-eraser text-sm"></i>
                        </button>
                    </div>
                    <div class="flex-1 overflow-auto mb-3">
                        <div class="response-content text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap"></div>
                    </div>
                    <div class="flex gap-2">
                        <button class="preview-btn flex-1 px-3 py-1 bg-primary text-white rounded text-xs hover:bg-opacity-90" title="Preview">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="copy-btn px-3 py-1 bg-gray-500 text-white rounded text-xs hover:bg-opacity-90">Copy</button>
                        <button class="download-btn px-3 py-1 bg-green-500 text-white rounded text-xs hover:bg-opacity-90">Download</button>
                    </div>
                </div>
            </div>
            <div class="response-box" data-index="2">
                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 h-80 flex flex-col">
                    <div class="flex items-center gap-2 mb-3">
                        <select class="model-select flex-1 p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-sm">
                            <option value="">Select Model</option>
                        </select>
                        <button class="clear-response-btn p-2 text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition-colors" title="Clear this response">
                            <i class="fas fa-eraser text-sm"></i>
                        </button>
                    </div>
                    <div class="flex-1 overflow-auto mb-3">
                        <div class="response-content text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap"></div>
                    </div>
                    <div class="flex gap-2">
                        <button class="preview-btn flex-1 px-3 py-1 bg-primary text-white rounded text-xs hover:bg-opacity-90" title="Preview">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="copy-btn px-3 py-1 bg-gray-500 text-white rounded text-xs hover:bg-opacity-90">Copy</button>
                        <button class="download-btn px-3 py-1 bg-green-500 text-white rounded text-xs hover:bg-opacity-90">Download</button>
                    </div>
                </div>
            </div>
            <div class="response-box" data-index="3">
                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 h-80 flex flex-col">
                    <div class="flex items-center gap-2 mb-3">
                        <select class="model-select flex-1 p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-sm">
                            <option value="">Select Model</option>
                        </select>
                        <button class="clear-response-btn p-2 text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition-colors" title="Clear this response">
                            <i class="fas fa-eraser text-sm"></i>
                        </button>
                    </div>
                    <div class="flex-1 overflow-auto mb-3">
                        <div class="response-content text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap"></div>
                    </div>
                    <div class="flex gap-2">
                        <button class="preview-btn flex-1 px-3 py-1 bg-primary text-white rounded text-xs hover:bg-opacity-90" title="Preview">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="copy-btn px-3 py-1 bg-gray-500 text-white rounded text-xs hover:bg-opacity-90">Copy</button>
                        <button class="download-btn px-3 py-1 bg-green-500 text-white rounded text-xs hover:bg-opacity-90">Download</button>
                    </div>
                </div>
            </div>
            <div class="response-box" data-index="4">
                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 h-80 flex flex-col">
                    <div class="flex items-center gap-2 mb-3">
                        <select class="model-select flex-1 p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 text-sm">
                            <option value="">Select Model</option>
                        </select>
                        <button class="clear-response-btn p-2 text-gray-600 dark:text-gray-400 hover:text-primary dark:hover:text-primary transition-colors" title="Clear this response">
                            <i class="fas fa-eraser text-sm"></i>
                        </button>
                    </div>
                    <div class="flex-1 overflow-auto mb-3">
                        <div class="response-content text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap"></div>
                    </div>
                    <div class="flex gap-2">
                        <button class="preview-btn flex-1 px-3 py-1 bg-primary text-white rounded text-xs hover:bg-opacity-90" title="Preview">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="copy-btn px-3 py-1 bg-gray-500 text-white rounded text-xs hover:bg-opacity-90">Copy</button>
                        <button class="download-btn px-3 py-1 bg-green-500 text-white rounded text-xs hover:bg-opacity-90">Download</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Preview</h3>
                <button id="copyPreview" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-opacity-90 transition-colors">
                    <i class="fas fa-copy mr-2"></i>Copy
                </button>
            </div>
            <div id="previewContent" class="min-h-32 p-4 bg-white dark:bg-gray-700 rounded border text-gray-700 dark:text-gray-300 whitespace-pre-wrap overflow-auto max-h-96">
                Select a response to preview...
            </div>
        </div>
    </div>

    <script>
        // Dark mode setup
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Models list
        const models = [
            'Web-Search',
            'Linkup-Standard',
            'Gemini-2.5-Pro',
            'Gemini-2.5-Flash',
            'Gemini-2.5-Flash-Lite-Preview',
            'Gemini-2.0-Flash',
            'GPT-4o-Search',
            'Claude-Opus-4-Search',
            'Claude-Sonnet-4-Search',
            'Claude-Sonnet-3.7-Search',
            'Grok-4',
            'Claude-Haiku-3.5-Search',
            'Perplexity-Sonar-Rsn',
            'Perplexity-Sonar',
            'GPT-Researcher',
            'Perplexity-Sonar-Pro',
            'Perplexity-Sonar-Rsn-Pro',
            'Reka-Research',
            'Bagoodex-Web-Search',
            'GPT-4o-mini-Search',
            'Gemini-1.5-Pro-Search',
            'Gemini-1.5-Flash-Search'
        ];

        // State
        let conversationHistory = [];
        let responses = ['', '', '', '', ''];

        // Populate dropdowns
        document.querySelectorAll('.model-select').forEach(select => {
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                select.appendChild(option);
            });
        });

        // Utility functions
        function getTimestamp() {
            const now = new Date();
            const months = ['january', 'february', 'march', 'april', 'may', 'june',
                          'july', 'august', 'september', 'october', 'november', 'december'];
            const month = months[now.getMonth()];
            const day = now.getDate();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            return `${month}${day}_${hours}-${minutes}-${seconds}`;
        }

        function downloadText(text, filename) {
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showToast('Failed to copy');
            });
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-primary text-white px-4 py-2 rounded shadow-lg z-50';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 2000);
        }

        // Register handlers
        window.Poe.registerHandler('response-handler', (result, context) => {
            const { boxIndex } = context;
            const msg = result.responses[0];
            const responseBox = document.querySelector(`.response-box[data-index="${boxIndex}"] .response-content`);
            
            if (msg.status === 'error') {
                responseBox.textContent = 'Error: ' + (msg.statusText || 'Unknown error');
                responses[boxIndex] = responseBox.textContent;
            } else if (msg.status === 'incomplete') {
                responseBox.textContent = msg.content || 'Generating...';
                responses[boxIndex] = responseBox.textContent;
            } else if (msg.status === 'complete') {
                responseBox.textContent = msg.content;
                responses[boxIndex] = msg.content;
            }
        });

        // Send button handler
        document.getElementById('sendButton').addEventListener('click', async () => {
            const prompt = document.getElementById('promptInput').value.trim();
            if (!prompt) {
                showToast('Please enter a prompt');
                return;
            }

            // Add to conversation history
            conversationHistory.push(prompt);
            
            // Build context string
            const contextPrompt = conversationHistory.join('\n\n');

            // Send to selected models
            const responseBoxes = document.querySelectorAll('.response-box');
            
            for (let i = 0; i < responseBoxes.length; i++) {
                const box = responseBoxes[i];
                const select = box.querySelector('.model-select');
                const selectedModel = select.value;
                
                if (selectedModel) {
                    const responseContent = box.querySelector('.response-content');
                    responseContent.textContent = 'Sending...';
                    
                    try {
                        const fullPrompt = `@${selectedModel} ${contextPrompt}`;
                        await window.Poe.sendUserMessage(fullPrompt, {
                            handler: 'response-handler',
                            stream: true,
                            openChat: false,
                            handlerContext: { boxIndex: i }
                        });
                    } catch (err) {
                        responseContent.textContent = 'Error: ' + err.message;
                        responses[i] = responseContent.textContent;
                    }
                }
            }
        });

        // Preview buttons
        document.querySelectorAll('.preview-btn').forEach((btn, index) => {
            btn.addEventListener('click', () => {
                const content = responses[index] || 'No response yet';
                document.getElementById('previewContent').textContent = content;
            });
        });

        // Copy buttons
        document.querySelectorAll('.copy-btn').forEach((btn, index) => {
            btn.addEventListener('click', () => {
                const content = responses[index] || '';
                if (content) {
                    copyToClipboard(content);
                } else {
                    showToast('No content to copy');
                }
            });
        });

        // Download buttons
        document.querySelectorAll('.download-btn').forEach((btn, index) => {
            btn.addEventListener('click', () => {
                const content = responses[index] || '';
                if (content) {
                    const filename = `webbot${index + 1}_${getTimestamp()}.txt`;
                    downloadText(content, filename);
                } else {
                    showToast('No content to download');
                }
            });
        });

        // Preview copy button
        document.getElementById('copyPreview').addEventListener('click', () => {
            const content = document.getElementById('previewContent').textContent;
            if (content && content !== 'Select a response to preview...') {
                copyToClipboard(content);
            } else {
                showToast('No content to copy');
            }
        });

        // Save state
        document.getElementById('saveState').addEventListener('click', () => {
            const state = {
                conversationHistory: conversationHistory,
                responses: responses,
                selectedModels: Array.from(document.querySelectorAll('.model-select')).map(select => select.value),
                timestamp: new Date().toISOString()
            };
            const stateJson = JSON.stringify(state, null, 2);
            copyToClipboard(stateJson);
            showToast('State copied to clipboard!');
        });

        // Import state modal
        document.getElementById('importState').addEventListener('click', () => {
            document.getElementById('importModal').classList.remove('hidden');
            document.getElementById('stateInput').value = '';
            document.getElementById('stateInput').focus();
        });

        document.getElementById('cancelImport').addEventListener('click', () => {
            document.getElementById('importModal').classList.add('hidden');
        });

        document.getElementById('loadState').addEventListener('click', () => {
            const stateJson = document.getElementById('stateInput').value.trim();
            if (!stateJson) {
                showToast('Please paste JSON state');
                return;
            }

            try {
                const state = JSON.parse(stateJson);
                
                // Restore conversation history
                conversationHistory = state.conversationHistory || [];
                
                // Restore responses
                responses = state.responses || ['', '', '', '', ''];
                responses.forEach((response, index) => {
                    const responseContent = document.querySelector(`.response-box[data-index="${index}"] .response-content`);
                    responseContent.textContent = response;
                });
                
                // Restore selected models
                if (state.selectedModels) {
                    state.selectedModels.forEach((model, index) => {
                        const select = document.querySelector(`.response-box[data-index="${index}"] .model-select`);
                        if (select) select.value = model;
                    });
                }
                
                document.getElementById('importModal').classList.add('hidden');
                showToast('State imported successfully!');
            } catch (err) {
                showToast('Failed to import state: Invalid JSON');
            }
        });

        // Close modal when clicking outside
        document.getElementById('importModal').addEventListener('click', (e) => {
            if (e.target.id === 'importModal') {
                document.getElementById('importModal').classList.add('hidden');
            }
        });

        // Download flow
        document.getElementById('downloadFlow').addEventListener('click', () => {
            const hasContent = responses.some(response => response.trim());
            if (!hasContent) {
                showToast('No responses to download');
                return;
            }

            let allContent = 'Model Aggregator Export\n';
            allContent += '========================\n\n';
            allContent += `Export Date: ${new Date().toLocaleString()}\n\n`;
            
            if (conversationHistory.length > 0) {
                allContent += 'Conversation History:\n';
                allContent += conversationHistory.join('\n\n') + '\n\n';
            }
            
            responses.forEach((response, index) => {
                if (response.trim()) {
                    const selectedModel = document.querySelector(`.response-box[data-index="${index}"] .model-select`).value;
                    allContent += `=== WebBot ${index + 1} (${selectedModel || 'No model selected'}) ===\n`;
                    allContent += response + '\n\n';
                }
            });

            const filename = `all_responses_${getTimestamp()}.txt`;
            downloadText(allContent, filename);
        });

        // Clear state
        document.getElementById('clearState').addEventListener('click', () => {
            conversationHistory = [];
            responses = ['', '', '', '', ''];
            document.querySelectorAll('.response-content').forEach(el => el.textContent = '');
            document.getElementById('previewContent').textContent = 'Select a response to preview...';
            document.querySelectorAll('.model-select').forEach(select => select.value = '');
            document.getElementById('promptInput').value = '';
            showToast('State cleared!');
        });

        // Clear individual responses
        document.querySelectorAll('.clear-response-btn').forEach((btn, index) => {
            btn.addEventListener('click', () => {
                const originalResponse = responses[index];
                responses[index] = '';
                const responseContent = document.querySelector(`.response-box[data-index="${index}"] .response-content`);
                responseContent.textContent = '';
                if (document.getElementById('previewContent').textContent === originalResponse) {
                    document.getElementById('previewContent').textContent = 'Select a response to preview...';
                }
                showToast('Response cleared!');
            });
        });
    </script>
</body>
</html>

