<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRBanger Enhanced Legal Research System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <style>
        :root {
            --primary: #5D5CDE;
            --primary-hover: #4A49CC;
            --bg-primary: #ffffff;
            --bg-secondary: #f7f7f7;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --border: #e0e0e0;
            --selected: #5D5CDE;
            --selected-bg: rgba(93, 92, 222, 0.1);
            --accent: #5D5CDE;
        }

        .dark {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --border: #3a3a3a;
            --selected-bg: rgba(93, 92, 222, 0.2);
        }

        .accordion-container {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .accordion-container.collapsed {
            max-height: 40px;
        }

        .selected-display {
            padding: 12px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            color: var(--text-secondary);
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: background 0.2s;
        }

        .selected-display:hover {
            background: rgba(93, 92, 222, 0.05);
        }

        .accordion-container.collapsed .selected-display {
            border-bottom: none;
        }

        .selected-model {
            color: var(--primary);
            font-weight: 600;
        }

        .expand-icon {
            width: 16px;
            height: 16px;
            color: var(--text-secondary);
            transition: transform 0.3s;
        }

        .accordion-container.collapsed .expand-icon {
            transform: rotate(0deg);
        }

        .accordion-container:not(.collapsed) .expand-icon {
            transform: rotate(90deg);
        }

        .clear-selection {
            padding: 4px 8px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s;
            margin-right: 6px;
        }

        .clear-selection:hover {
            background: var(--bg-primary);
            border-color: var(--primary);
            color: var(--primary);
        }

        .accordion-wrapper {
            max-height: 300px;
            overflow-y: auto;
            opacity: 1;
            transition: opacity 0.3s;
        }

        .accordion-container.collapsed .accordion-wrapper {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }

        .accordion-item {
            border-bottom: 1px solid var(--border);
        }

        .accordion-item:last-child {
            border-bottom: none;
        }

        .accordion-header {
            padding: 10px 12px;
            background: var(--bg-primary);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
            user-select: none;
        }

        .accordion-header:hover {
            background: var(--bg-secondary);
        }

        .accordion-header.active {
            background: var(--bg-secondary);
            font-weight: 600;
        }

        .accordion-title {
            font-size: 13px;
            color: var(--text-primary);
        }

        .accordion-icon {
            width: 16px;
            height: 16px;
            transition: transform 0.3s;
            color: var(--text-secondary);
        }

        .accordion-header.active .accordion-icon {
            transform: rotate(90deg);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: var(--bg-secondary);
        }

        .accordion-content.active {
            max-height: 300px;
            overflow-y: auto;
            transition: max-height 0.5s ease-in;
        }

        .series-item {
            border-left: 2px solid transparent;
            margin-left: 12px;
        }

        .series-header {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            font-size: 12px;
            color: var(--text-primary);
        }

        .series-header:hover {
            background: rgba(93, 92, 222, 0.05);
            border-left-color: var(--primary);
        }

        .series-header.active {
            background: rgba(93, 92, 222, 0.08);
            border-left-color: var(--primary);
            font-weight: 600;
        }

        .series-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            margin-left: 12px;
        }

        .series-content.active {
            max-height: 200px;
            transition: max-height 0.5s ease-in;
        }

        .model-item {
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 11px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: 12px;
        }

        .model-item:hover {
            background: rgba(93, 92, 222, 0.08);
            padding-left: 16px;
        }

        .model-item.selected {
            background: var(--selected-bg);
            color: var(--primary);
            font-weight: 600;
        }

        .model-item.selected::before {
            content: "✓";
            color: var(--primary);
            font-weight: bold;
        }

        .model-item.highlighted {
            background: rgba(93, 92, 222, 0.12);
            border-left: 2px solid var(--primary);
            outline: 1px solid var(--primary);
        }

        .model-count {
            font-size: 9px;
            color: var(--text-secondary);
            background: var(--bg-primary);
            padding: 1px 4px;
            border-radius: 6px;
        }

        .accordion-wrapper::-webkit-scrollbar {
            width: 6px;
        }

        .accordion-wrapper::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .accordion-wrapper::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .accordion-wrapper::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Tab System Styles */
        .tab-button {
            background: transparent;
            color: #6b7280;
            border: none;
            transition: all 0.2s ease;
        }

        .tab-button.active {
            background: #5D5CDE;
            color: white;
            box-shadow: 0 2px 8px rgba(93, 92, 222, 0.3);
        }

        .tab-button:hover:not(.active) {
            background: rgba(93, 92, 222, 0.1);
            color: #5D5CDE;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Floating button smaller size */
        #floatingNextBot {
            position: fixed;
            top: 4px;
            left: 4px;
            z-index: 50;
        }

        #nextBotButton {
            padding: 8px 12px;
            font-size: 12px;
        }
    </style>
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-[#5D5CDE] mb-2">🎯 DRBanger Enhanced Legal Research System</h1>
            <p class="text-gray-600 dark:text-gray-400">6-Bot Manual Workflow: SST Application → Web Adversary → International Law Validation → ICC Insight Extraction → Web Verification → Dynamic SST Generation</p>
        </div>

        <div class="mb-6">
            <div class="flex space-x-1 bg-gray-100 dark:bg-gray-800 p-1 rounded-lg">
                <button id="tab-input" class="tab-button active flex-1 py-3 px-6 rounded-md text-sm font-medium transition-all duration-200">
                    📋 Input Configuration
                </button>
                <button id="tab-results" class="tab-button flex-1 py-3 px-6 rounded-md text-sm font-medium transition-all duration-200">
                    ⚡ Execution & Results
                </button>
            </div>
        </div>

        <div id="errorToast" class="fixed top-4 right-4 z-50 hidden">
            <div class="bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg max-w-sm">
                <div id="errorToastMessage" class="text-sm"></div>
            </div>
        </div>

        <div id="copyToast" class="fixed top-4 right-4 z-50 hidden">
            <div class="bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg max-w-sm">
                <div class="text-sm">📋 Copied to clipboard</div>
            </div>
        </div>

        <div id="floatingNextBot" class="fixed top-4 left-4 z-50">
            <button id="nextBotButton" class="bg-[#5D5CDE] hover:bg-[#4A4BC7] text-white px-4 py-3 rounded-lg shadow-lg transition-all duration-200 flex items-center space-x-2 relative">
                <span id="nextBotText">▶️ Start Bot 1</span>
                <div id="nextBotSpinner" class="hidden">
                    <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                </div>
            </button>
        </div>

        <div id="stateToast" class="fixed top-4 right-4 z-50 hidden">
            <div class="bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg max-w-sm">
                <div id="stateToastMessage" class="text-sm"></div>
            </div>
        </div>

        <div id="loadStateModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col">
                <h3 class="text-lg font-semibold mb-4">📁 Load State</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Paste the saved state JSON below. This will replace all current content.</p>
                <textarea 
                    id="loadStateTextarea" 
                    class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base resize-none flex-1 min-h-[300px]"
                    placeholder="Paste your DRBanger state JSON here..."
                ></textarea>
                <div class="flex justify-end space-x-3 mt-4">
                    <button id="cancelLoadState" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">Cancel</button>
                    <button id="confirmLoadState" class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded">Load State</button>
                </div>
            </div>
        </div>

        <input type="file" id="stateFileInput" accept=".json" style="display: none;">

        <div id="tab-content-input" class="tab-content active">
            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">📝 Input Configuration</h2>
                <div class="flex space-x-2">
                    <button id="saveStateInput" class="p-2 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200" title="Copy State to Clipboard">
                        💾
                    </button>
                    <button id="downloadStateInput" class="p-2 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200" title="Download State as File">
                        📥
                    </button>
                    <button id="loadStateInput" class="p-2 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200" title="Load State from File">
                        📁
                    </button>
                    <button id="importStateInput" class="p-2 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200" title="Import State from Clipboard">
                        📋
                    </button>
                    <button id="downloadFlow" class="p-2 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200" title="Download Responses">
                        📄
                    </button>
                </div>
            </div>

            <div class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                <h3 class="font-semibold mb-3 text-blue-800 dark:text-blue-200">📁 File Upload Center</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center">
                        <label class="block text-sm font-medium mb-2">Legal Texts Database</label>
                        <input type="file" id="legalTextFile" accept=".json" class="w-full text-sm">
                        <p class="text-xs text-gray-500 mt-1">JSON array of legal texts</p>
                    </div>
                    <div class="text-center">
                        <label class="block text-sm font-medium mb-2">SST Techniques Database</label>
                        <input type="file" id="sstDatabaseFile" accept=".json" class="w-full text-sm">
                        <p class="text-xs text-gray-500 mt-1">Hierarchical SST database</p>
                    </div>
                    <div class="text-center">
                        <label class="block text-sm font-medium mb-2">Bot Prompts Database</label>
                        <input type="file" id="botPromptsFile" accept=".json" class="w-full text-sm">
                        <p class="text-xs text-gray-500 mt-1">Bot prompt templates</p>
                    </div>
                </div>
                <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div>
                        <span id="legalTextDatabaseStatus" class="text-gray-600 dark:text-gray-400">No database loaded</span>
                    </div>
                    <div>
                        <span id="sstDatabaseStatus" class="text-gray-600 dark:text-gray-400">No database loaded</span>
                    </div>
                    <div>
                        <span id="botPromptsDatabaseStatus" class="text-gray-600 dark:text-gray-400">No database loaded</span>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Legal Text (e.g., ICC Article 17)</label>
                <div class="relative">
                    <textarea 
                        id="legalText" 
                        class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base resize-vertical"
                        rows="4"
                        placeholder="Enter the legal text you want to analyze..."
                    ></textarea>
                    <div class="absolute top-2 right-2 flex space-x-1">
                        <button id="copyLegalText" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Copy to Clipboard">📋</button>
                        <button id="feedLegalText" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Feed to Preview">📤</button>
                    </div>
                </div>
                
                <div class="mt-3 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                    <h4 class="font-semibold mb-2 text-blue-800 dark:text-blue-200 text-sm">📖 Legal Text Database</h4>
                    <div class="flex items-center space-x-3 mt-2">
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600 dark:text-gray-400">Find by ID:</label>
                            <input 
                                type="text" 
                                id="legalTextSearch" 
                                class="w-20 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-sm"
                                placeholder="ID"
                            >
                            <button 
                                id="loadLegalTextById"
                                class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm"
                                disabled
                            >
                                Load
                            </button>
                        </div>
                        <button 
                            id="randomizeLegalText"
                            class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-sm"
                            disabled
                        >
                            🎲 Random
                        </button>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">SST Technique</label>
                <div class="relative">
                    <textarea 
                        id="sstCapsule" 
                        class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-base resize-vertical"
                        rows="3"
                        placeholder="Enter an SST technique or load from JSON database..."
                    ></textarea>
                    <div class="absolute top-2 right-2 flex space-x-1">
                        <button id="copySSTCapsule" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Copy to Clipboard">📋</button>
                        <button id="feedSSTCapsule" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Feed to Preview">📤</button>
                    </div>
                </div>
                
                <div class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                    <h3 class="font-semibold mb-3 text-blue-800 dark:text-blue-200">🎯 Manual SST Selection</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="block text-sm font-medium mb-2">Domain</label>
                            <select id="sstDomainSelect" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-base">
                                <option value="">Select a domain...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Technique</label>
                            <select id="sstTechniqueSelect" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-base" disabled>
                                <option value="">Select a technique...</option>
                            </select>
                        </div>
                    </div>
                    <button 
                        id="sampleSSTBtn"
                        class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-sm rounded hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors"
                    >
                        🎲 Sample Random SST
                    </button>
                </div>
            </div>



            <div class="mb-4 p-4 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg border border-indigo-200 dark:border-indigo-800">
                <h3 class="font-semibold mb-3 text-indigo-800 dark:text-indigo-200">🎯 Bot 6: Dynamic SST Generator</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                    <div>
                        <label class="block text-sm font-medium mb-2">Custom Domain (Optional)</label>
                        <input 
                            type="text" 
                            id="customDomain" 
                            class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-base"
                            placeholder="Enter specific domain for SST generation..."
                        >
                    </div>
                    <div class="flex items-end">
                        <button 
                            id="executeBot6Panel"
                            class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition-colors text-sm w-full relative"
                        >
                            <span id="executeBot6PanelText">🎯 Generate Optimized SST</span>
                            <div id="executeBot6PanelSpinner" class="hidden absolute inset-0 flex items-center justify-center">
                                <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                            </div>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Communication & Instructions (Optional)</label>
                    <textarea 
                        id="customInstruction" 
                        class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-base resize-vertical"
                        rows="3"
                        placeholder="Provide specific feedback, corrections, or guidance for SST generation..."
                    ></textarea>
                </div>
            </div>

            <div class="mb-4 p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800">
                <h3 class="font-semibold mb-2 text-green-800 dark:text-green-200">🔄 Workflow Progress</h3>
                <div class="flex flex-wrap gap-2">
                    <div class="flex items-center">
                        <span id="step1Status" class="px-3 py-1 rounded-full text-xs bg-gray-200 dark:bg-gray-700">1. SST Application</span>
                        <div id="step1Spinner" class="hidden ml-2 animate-spin rounded-full h-4 w-4 border-2 border-blue-500 border-t-transparent"></div>
                    </div>
                    <div class="flex items-center">
                        <span id="step2Status" class="px-3 py-1 rounded-full text-xs bg-gray-200 dark:bg-gray-700">2. Web Adversary</span>
                        <div id="step2Spinner" class="hidden ml-2 animate-spin rounded-full h-4 w-4 border-2 border-green-500 border-t-transparent"></div>
                    </div>
                    <div class="flex items-center">
                        <span id="step3Status" class="px-3 py-1 rounded-full text-xs bg-gray-200 dark:bg-gray-700">3. International Law</span>
                        <div id="step3Spinner" class="hidden ml-2 animate-spin rounded-full h-4 w-4 border-2 border-purple-500 border-t-transparent"></div>
                    </div>
                    <div class="flex items-center">
                        <span id="step4Status" class="px-3 py-1 rounded-full text-xs bg-gray-200 dark:bg-gray-700">4. ICC Insights</span>
                        <div id="step4Spinner" class="hidden ml-2 animate-spin rounded-full h-4 w-4 border-2 border-red-500 border-t-transparent"></div>
                    </div>
                    <div class="flex items-center">
                        <span id="step5Status" class="px-3 py-1 rounded-full text-xs bg-gray-200 dark:bg-gray-700">5. Web Verification</span>
                        <div id="step5Spinner" class="hidden ml-2 animate-spin rounded-full h-4 w-4 border-2 border-teal-500 border-t-transparent"></div>
                    </div>
                    <div class="flex items-center">
                        <span id="step6Status" class="px-3 py-1 rounded-full text-xs bg-gray-200 dark:bg-gray-700">6. SST Generation</span>
                        <div id="step6Spinner" class="hidden ml-2 animate-spin rounded-full h-4 w-4 border-2 border-indigo-500 border-t-transparent"></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                <button id="executeBot1" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm relative">
                    <span id="executeBot1Text">▶️ Bot 1</span>
                    <div id="executeBot1Spinner" class="hidden absolute inset-0 flex items-center justify-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                    </div>
                </button>
                <button id="executeBot2" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-sm relative">
                    <span id="executeBot2Text">▶️ Bot 2</span>
                    <div id="executeBot2Spinner" class="hidden absolute inset-0 flex items-center justify-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                    </div>
                </button>
                <button id="executeBot3" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors text-sm relative">
                    <span id="executeBot3Text">▶️ Bot 3</span>
                    <div id="executeBot3Spinner" class="hidden absolute inset-0 flex items-center justify-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                    </div>
                </button>
                <button id="executeBot4" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors text-sm relative">
                    <span id="executeBot4Text">▶️ Bot 4</span>
                    <div id="executeBot4Spinner" class="hidden absolute inset-0 flex items-center justify-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                    </div>
                </button>
                <button id="executeBot5" class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700 transition-colors text-sm relative">
                    <span id="executeBot5Text">▶️ Bot 5</span>
                    <div id="executeBot5Spinner" class="hidden absolute inset-0 flex items-center justify-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                    </div>
                </button>
                <button id="executeBot6" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition-colors text-sm relative">
                    <span id="executeBot6Text">▶️ Bot 6</span>
                    <div id="executeBot6Spinner" class="hidden absolute inset-0 flex items-center justify-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                    </div>
                </button>
            </div>
        </div>

            <div class="mb-6 text-center">
                <button id="downloadAllResponses" class="px-6 py-3 bg-[#5D5CDE] text-white rounded-lg hover:bg-[#4A4BC7] transition-colors text-sm font-medium">
                    📄 Download All Responses
                </button>
            </div>

            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">🤖 Model Selection</h2>
                <span class="text-sm text-gray-600 dark:text-gray-400">Choose models for each bot in the workflow</span>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="bg-white dark:bg-gray-700 rounded-lg p-4 border border-blue-200 dark:border-blue-800">
                    <h3 class="text-sm font-semibold mb-3 text-blue-800 dark:text-blue-200">Bot 1: SST Application</h3>
                    <div class="accordion-container collapsed" id="selector-container-bot1">
                        <div class="selected-display" onclick="toggleBotAccordion('bot1')">
                            <input id="model-search-bot1" type="text" placeholder="Search or select model..."
                                class="flex-1 min-w-0 text-sm px-2 py-1 rounded"
                                style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); outline: none;" />
                            <div style="display: flex; align-items: center;">
                                <button class="clear-selection" id="clear-btn-bot1" style="display: none;" onclick="clearBotSelection(event, 'bot1')">Clear</button>
                                <svg class="expand-icon" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        </div>
                        <div class="accordion-wrapper" id="accordion-root-bot1"></div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-700 rounded-lg p-4 border border-green-200 dark:border-green-800">
                    <h3 class="text-sm font-semibold mb-3 text-green-800 dark:text-green-200">Bot 2: Web Adversary</h3>
                    <div class="accordion-container collapsed" id="selector-container-bot2">
                        <div class="selected-display" onclick="toggleBotAccordion('bot2')">
                            <input id="model-search-bot2" type="text" placeholder="Search or select model..."
                                class="flex-1 min-w-0 text-sm px-2 py-1 rounded"
                                style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); outline: none;" />
                            <div style="display: flex; align-items: center;">
                                <button class="clear-selection" id="clear-btn-bot2" style="display: none;" onclick="clearBotSelection(event, 'bot2')">Clear</button>
                                <svg class="expand-icon" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        </div>
                        <div class="accordion-wrapper" id="accordion-root-bot2"></div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-700 rounded-lg p-4 border border-purple-200 dark:border-purple-800">
                    <h3 class="text-sm font-semibold mb-3 text-purple-800 dark:text-purple-200">Bot 3: International Law SST</h3>
                    <div class="accordion-container collapsed" id="selector-container-bot3">
                        <div class="selected-display" onclick="toggleBotAccordion('bot3')">
                            <input id="model-search-bot3" type="text" placeholder="Search or select model..."
                                class="flex-1 min-w-0 text-sm px-2 py-1 rounded"
                                style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); outline: none;" />
                            <div style="display: flex; align-items: center;">
                                <button class="clear-selection" id="clear-btn-bot3" style="display: none;" onclick="clearBotSelection(event, 'bot3')">Clear</button>
                                <svg class="expand-icon" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        </div>
                        <div class="accordion-wrapper" id="accordion-root-bot3"></div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-700 rounded-lg p-4 border border-red-200 dark:border-red-800">
                    <h3 class="text-sm font-semibold mb-3 text-red-800 dark:text-red-200">Bot 4: ICC Insight Extractor</h3>
                    <div class="accordion-container collapsed" id="selector-container-bot4">
                        <div class="selected-display" onclick="toggleBotAccordion('bot4')">
                            <input id="model-search-bot4" type="text" placeholder="Search or select model..."
                                class="flex-1 min-w-0 text-sm px-2 py-1 rounded"
                                style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); outline: none;" />
                            <div style="display: flex; align-items: center;">
                                <button class="clear-selection" id="clear-btn-bot4" style="display: none;" onclick="clearBotSelection(event, 'bot4')">Clear</button>
                                <svg class="expand-icon" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        </div>
                        <div class="accordion-wrapper" id="accordion-root-bot4"></div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-700 rounded-lg p-4 border border-teal-200 dark:border-teal-800">
                    <h3 class="text-sm font-semibold mb-3 text-teal-800 dark:text-teal-200">Bot 5: Web Verification</h3>
                    <div class="accordion-container collapsed" id="selector-container-bot5">
                        <div class="selected-display" onclick="toggleBotAccordion('bot5')">
                            <input id="model-search-bot5" type="text" placeholder="Search or select model..."
                                class="flex-1 min-w-0 text-sm px-2 py-1 rounded"
                                style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); outline: none;" />
                            <div style="display: flex; align-items: center;">
                                <button class="clear-selection" id="clear-btn-bot5" style="display: none;" onclick="clearBotSelection(event, 'bot5')">Clear</button>
                                <svg class="expand-icon" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        </div>
                        <div class="accordion-wrapper" id="accordion-root-bot5"></div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-700 rounded-lg p-4 border border-indigo-200 dark:border-indigo-800">
                    <h3 class="text-sm font-semibold mb-3 text-indigo-800 dark:text-indigo-200">Bot 6: Dynamic SST Generator</h3>
                    <div class="accordion-container collapsed" id="selector-container-bot6">
                        <div class="selected-display" onclick="toggleBotAccordion('bot6')">
                            <input id="model-search-bot6" type="text" placeholder="Search or select model..."
                                class="flex-1 min-w-0 text-sm px-2 py-1 rounded"
                                style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); outline: none;" />
                            <div style="display: flex; align-items: center;">
                                <button class="clear-selection" id="clear-btn-bot6" style="display: none;" onclick="clearBotSelection(event, 'bot6')">Clear</button>
                                <svg class="expand-icon" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        </div>
                        <div class="accordion-wrapper" id="accordion-root-bot6"></div>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <div id="tab-content-results" class="tab-content">
        <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 mb-6">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-semibold">🎯 State Management</h3>
                <div class="flex space-x-2">
                    <button id="saveStateResults" class="p-2 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200" title="Copy State to Clipboard">
                        💾
                    </button>
                    <button id="downloadStateResults" class="p-2 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200" title="Download State as File">
                        📥
                    </button>
                    <button id="loadStateResults" class="p-2 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200" title="Load State from File">
                        📁
                    </button>
                    <button id="importStateResults" class="p-2 text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200" title="Import State from Clipboard">
                        📋
                    </button>
                </div>
            </div>
        </div>
        
        <div id="resultsSection" class="space-y-6">
            <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-6">
                <h3 class="text-lg font-semibold flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <span class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm mr-3">1</span>
                        🔍 SST Mechanical Application Bot
                        <div class="ml-4 flex items-center space-x-2">
                            <input 
                                type="text" 
                                id="bot1PromptSearch" 
                                class="w-16 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-xs"
                                placeholder="ID"
                            >
                            <button 
                                id="loadBot1Prompt"
                                class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-xs"
                                disabled
                            >
                                Load
                            </button>
                            <button 
                                id="randomBot1Prompt"
                                class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-xs"
                                disabled
                                title="Random Prompt"
                            >
                                🎲
                            </button>
                        </div>
                    </div>
                    <div class="flex space-x-1 items-center">
                        <label class="flex items-center cursor-pointer" title="Mark as Complete">
                            <input type="checkbox" id="manualCompleteBot1" class="mr-1">
                            <span class="text-xs text-gray-500">✓ Done</span>
                        </label>
                        <button id="resetBot1" class="p-1 text-orange-400 hover:text-orange-600 dark:hover:text-orange-300" title="Reset Bot State">🔄</button>
                        <button id="copyBot1" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Copy to Clipboard">📋</button>
                        <button id="downloadBot1" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Download as Markdown">💾</button>
                        <button id="feedBot1" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Feed to Preview">📤</button>
                        <button id="clearBot1" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Clear Output">🗑️</button>
                    </div>
                </h3>
                <div class="mb-2 flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <span class="text-xs text-gray-500">Model:</span>
                        <span id="bot1ModelDisplay" class="text-xs font-mono bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">Choose model</span>
                    </div>
                    <div id="bot1PromptStatus" class="text-xs text-gray-500">Default prompt</div>
                </div>
                <div class="mt-2">
                    <details class="group">
                        <summary id="bot1-injection-summary" class="text-xs text-gray-500 dark:text-gray-400 cursor-pointer select-none group-open:mb-2 hover:text-gray-700 dark:hover:text-gray-200">
                            ➕ Add Custom Instruction
                        </summary>
                        <div class="flex items-center space-x-2">
                            <textarea 
                                id="bot1-custom-instruction" 
                                class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm resize-none"
                                rows="2"
                                placeholder="e.g., 'Focus only on Article 17(1)(a)...'"
                            ></textarea>
                            <button id="inject-instruction-bot1" class="px-3 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors text-xs">
                                Inject
                            </button>
                            <button id="clear-instruction-bot1" class="px-3 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors text-xs hidden">
                                Clear
                            </button>
                        </div>
                    </details>
                </div>
                <div id="bot1Status" class="text-sm text-gray-600 dark:text-gray-400 mb-2"></div>
                <div id="bot1Output" class="prose dark:prose-invert max-w-none bg-white dark:bg-gray-800 p-4 rounded border min-h-[50px] max-h-[600px] overflow-y-auto"></div>
                <div class="mt-3 flex justify-center">
                    <button id="executeBot1Results" class="w-8 h-8 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition-colors text-sm font-bold flex items-center justify-center">
                        1
                    </button>
                </div>
            </div>

            <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-6">
                <h3 class="text-lg font-semibold flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <span class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center text-sm mr-3">2</span>
                        ⚡ Web Adversary Bot
                        <div class="ml-4 flex items-center space-x-2">
                            <input 
                                type="text" 
                                id="bot2PromptSearch" 
                                class="w-16 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-xs"
                                placeholder="ID"
                            >
                            <button 
                                id="loadBot2Prompt"
                                class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-xs"
                                disabled
                            >
                                Load
                            </button>
                            <button 
                                id="randomBot2Prompt"
                                class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-xs"
                                disabled
                                title="Random Prompt"
                            >
                                🎲
                            </button>
                        </div>
                    </div>
                    <div class="flex space-x-1 items-center">
                        <label class="flex items-center cursor-pointer" title="Mark as Complete">
                            <input type="checkbox" id="manualCompleteBot2" class="mr-1">
                            <span class="text-xs text-gray-500">✓ Done</span>
                        </label>
                        <button id="resetBot2" class="p-1 text-orange-400 hover:text-orange-600 dark:hover:text-orange-300" title="Reset Bot State">🔄</button>
                        <button id="copyBot2" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Copy to Clipboard">📋</button>
                        <button id="downloadBot2" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Download as Markdown">💾</button>
                        <button id="feedBot2" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Feed to Preview">📤</button>
                        <button id="clearBot2" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Clear Output">🗑️</button>
                    </div>
                </h3>
                <div class="mb-2 flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <span class="text-xs text-gray-500">Model:</span>
                        <span id="bot2ModelDisplay" class="text-xs font-mono bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">Choose model</span>
                    </div>
                    <div id="bot2PromptStatus" class="text-xs text-gray-500">Default prompt</div>
                </div>
                <div class="mt-2">
                    <details class="group">
                        <summary id="bot2-injection-summary" class="text-xs text-gray-500 dark:text-gray-400 cursor-pointer select-none group-open:mb-2 hover:text-gray-700 dark:hover:text-gray-200">
                            ➕ Add Custom Instruction
                        </summary>
                        <div class="flex items-center space-x-2">
                            <textarea 
                                id="bot2-custom-instruction" 
                                class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm resize-none"
                                rows="2"
                                placeholder="e.g., 'Focus only on Article 17(1)(a)...'"
                            ></textarea>
                            <button id="inject-instruction-bot2" class="px-3 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors text-xs">
                                Inject
                            </button>
                            <button id="clear-instruction-bot2" class="px-3 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors text-xs hidden">
                                Clear
                            </button>
                        </div>
                    </details>
                </div>
                <div id="bot2Status" class="text-sm text-gray-600 dark:text-gray-400 mb-2"></div>
                <div id="bot2Output" class="prose dark:prose-invert max-w-none bg-white dark:bg-gray-800 p-4 rounded border min-h-[50px] max-h-[600px] overflow-y-auto"></div>
                <div class="mt-3 flex justify-center">
                    <button id="executeBot2Results" class="w-8 h-8 bg-green-600 text-white rounded-full hover:bg-green-700 transition-colors text-sm font-bold flex items-center justify-center">
                        2
                    </button>
                </div>
            </div>

            <div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-6">
                <h3 class="text-lg font-semibold flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <span class="w-8 h-8 bg-purple-500 text-white rounded-full flex items-center justify-center text-sm mr-3">3</span>
                        🧪 International Law SST Applicator Bot
                        <div class="ml-4 flex items-center space-x-2">
                            <input 
                                type="text" 
                                id="bot3PromptSearch" 
                                class="w-16 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-xs"
                                placeholder="ID"
                            >
                            <button 
                                id="loadBot3Prompt"
                                class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-xs"
                                disabled
                            >
                                Load
                            </button>
                            <button 
                                id="randomBot3Prompt"
                                class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-xs"
                                disabled
                                title="Random Prompt"
                            >
                                🎲
                            </button>
                        </div>
                    </div>
                    <div class="flex space-x-1 items-center">
                        <label class="flex items-center cursor-pointer" title="Mark as Complete">
                            <input type="checkbox" id="manualCompleteBot3" class="mr-1">
                            <span class="text-xs text-gray-500">✓ Done</span>
                        </label>
                        <button id="resetBot3" class="p-1 text-orange-400 hover:text-orange-600 dark:hover:text-orange-300" title="Reset Bot State">🔄</button>
                        <button id="copyBot3" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Copy to Clipboard">📋</button>
                        <button id="downloadBot3" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Download as Markdown">💾</button>
                        <button id="feedBot3" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Feed to Preview">📤</button>
                        <button id="clearBot3" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Clear Output">🗑️</button>
                    </div>
                </h3>
                <div class="mb-2 flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <span class="text-xs text-gray-500">Model:</span>
                        <span id="bot3ModelDisplay" class="text-xs font-mono bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">Choose model</span>
                    </div>
                    <div id="bot3PromptStatus" class="text-xs text-gray-500">Default prompt</div>
                </div>
                <div class="mt-2">
                    <details class="group">
                        <summary id="bot3-injection-summary" class="text-xs text-gray-500 dark:text-gray-400 cursor-pointer select-none group-open:mb-2 hover:text-gray-700 dark:hover:text-gray-200">
                            ➕ Add Custom Instruction
                        </summary>
                        <div class="flex items-center space-x-2">
                            <textarea 
                                id="bot3-custom-instruction" 
                                class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm resize-none"
                                rows="2"
                                placeholder="e.g., 'Focus only on Article 17(1)(a)...'"
                            ></textarea>
                            <button id="inject-instruction-bot3" class="px-3 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors text-xs">
                                Inject
                            </button>
                            <button id="clear-instruction-bot3" class="px-3 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors text-xs hidden">
                                Clear
                            </button>
                        </div>
                    </details>
                </div>
                <div id="bot3Status" class="text-sm text-gray-600 dark:text-gray-400 mb-2"></div>
                <div id="bot3Output" class="prose dark:prose-invert max-w-none bg-white dark:bg-gray-800 p-4 rounded border min-h-[50px] max-h-[600px] overflow-y-auto"></div>
                <div class="mt-3 flex justify-center">
                    <button id="executeBot3Results" class="w-8 h-8 bg-purple-600 text-white rounded-full hover:bg-purple-700 transition-colors text-sm font-bold flex items-center justify-center">
                        3
                    </button>
                </div>
            </div>

            <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-6">
                <h3 class="text-lg font-semibold flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <span class="w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center text-sm mr-3">4</span>
                        ⚡ ICC Insight Extractor Bot
                        <div class="ml-4 flex items-center space-x-2">
                            <input 
                                type="text" 
                                id="bot4PromptSearch" 
                                class="w-16 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-xs"
                                placeholder="ID"
                            >
                            <button 
                                id="loadBot4Prompt"
                                class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-xs"
                                disabled
                            >
                                Load
                            </button>
                            <button 
                                id="randomBot4Prompt"
                                class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-xs"
                                disabled
                                title="Random Prompt"
                            >
                                🎲
                            </button>
                        </div>
                    </div>
                    <div class="flex space-x-1 items-center">
                        <label class="flex items-center cursor-pointer" title="Mark as Complete">
                            <input type="checkbox" id="manualCompleteBot4" class="mr-1">
                            <span class="text-xs text-gray-500">✓ Done</span>
                        </label>
                        <button id="resetBot4" class="p-1 text-orange-400 hover:text-orange-600 dark:hover:text-orange-300" title="Reset Bot State">🔄</button>
                        <button id="copyBot4" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Copy to Clipboard">📋</button>
                        <button id="downloadBot4" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Download as Markdown">💾</button>
                        <button id="feedBot4" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Feed to Preview">📤</button>
                        <button id="clearBot4" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Clear Output">🗑️</button>
                    </div>
                </h3>
                <div class="mb-2 flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <span class="text-xs text-gray-500">Model:</span>
                        <span id="bot4ModelDisplay" class="text-xs font-mono bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">Choose model</span>
                    </div>
                    <div id="bot4PromptStatus" class="text-xs text-gray-500">Default prompt</div>
                </div>
                <div class="mt-2">
                    <details class="group">
                        <summary id="bot4-injection-summary" class="text-xs text-gray-500 dark:text-gray-400 cursor-pointer select-none group-open:mb-2 hover:text-gray-700 dark:hover:text-gray-200">
                            ➕ Add Custom Instruction
                        </summary>
                        <div class="flex items-center space-x-2">
                            <textarea 
                                id="bot4-custom-instruction" 
                                class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm resize-none"
                                rows="2"
                                placeholder="e.g., 'Focus only on Article 17(1)(a)...'"
                            ></textarea>
                            <button id="inject-instruction-bot4" class="px-3 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors text-xs">
                                Inject
                            </button>
                            <button id="clear-instruction-bot4" class="px-3 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors text-xs hidden">
                                Clear
                            </button>
                        </div>
                    </details>
                </div>
                <div id="bot4Status" class="text-sm text-gray-600 dark:text-gray-400 mb-2"></div>
                <div id="bot4Output" class="prose dark:prose-invert max-w-none bg-white dark:bg-gray-800 p-4 rounded border min-h-[50px] max-h-[600px] overflow-y-auto"></div>
                <div class="mt-3 flex justify-center">
                    <button id="executeBot4Results" class="w-8 h-8 bg-red-600 text-white rounded-full hover:bg-red-700 transition-colors text-sm font-bold flex items-center justify-center">
                        4
                    </button>
                </div>
            </div>

            <div class="bg-teal-50 dark:bg-teal-900/20 rounded-lg p-6">
                <h3 class="text-lg font-semibold flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <span class="w-8 h-8 bg-teal-500 text-white rounded-full flex items-center justify-center text-sm mr-3">5</span>
                        🔍 Web Verification Bot
                        <div class="ml-4 flex items-center space-x-2">
                            <input 
                                type="text" 
                                id="bot5PromptSearch" 
                                class="w-16 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-xs"
                                placeholder="ID"
                            >
                            <button 
                                id="loadBot5Prompt"
                                class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-xs"
                                disabled
                            >
                                Load
                            </button>
                            <button 
                                id="randomBot5Prompt"
                                class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-xs"
                                disabled
                                title="Random Prompt"
                            >
                                🎲
                            </button>
                        </div>
                    </div>
                    <div class="flex space-x-1 items-center">
                        <label class="flex items-center cursor-pointer" title="Mark as Complete">
                            <input type="checkbox" id="manualCompleteBot5" class="mr-1">
                            <span class="text-xs text-gray-500">✓ Done</span>
                        </label>
                        <button id="resetBot5" class="p-1 text-orange-400 hover:text-orange-600 dark:hover:text-orange-300" title="Reset Bot State">🔄</button>
                        <button id="copyBot5" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Copy to Clipboard">📋</button>
                        <button id="downloadBot5" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Download as Markdown">💾</button>
                        <button id="feedBot5" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Feed to Preview">📤</button>
                        <button id="clearBot5" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Clear Output">🗑️</button>
                    </div>
                </h3>
                <div class="mb-2 flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <span class="text-xs text-gray-500">Model:</span>
                        <span id="bot5ModelDisplay" class="text-xs font-mono bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">Choose model</span>
                    </div>
                    <div id="bot5PromptStatus" class="text-xs text-gray-500">Default prompt</div>
                </div>
                <div class="mt-2">
                    <details class="group">
                        <summary id="bot5-injection-summary" class="text-xs text-gray-500 dark:text-gray-400 cursor-pointer select-none group-open:mb-2 hover:text-gray-700 dark:hover:text-gray-200">
                            ➕ Add Custom Instruction
                        </summary>
                        <div class="flex items-center space-x-2">
                            <textarea 
                                id="bot5-custom-instruction" 
                                class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm resize-none"
                                rows="2"
                                placeholder="e.g., 'Focus only on Article 17(1)(a)...'"
                            ></textarea>
                            <button id="inject-instruction-bot5" class="px-3 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors text-xs">
                                Inject
                            </button>
                            <button id="clear-instruction-bot5" class="px-3 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors text-xs hidden">
                                Clear
                            </button>
                        </div>
                    </details>
                </div>
                <div id="bot5Status" class="text-sm text-gray-600 dark:text-gray-400 mb-2"></div>
                <div id="bot5Output" class="prose dark:prose-invert max-w-none bg-white dark:bg-gray-800 p-4 rounded border min-h-[50px] max-h-[600px] overflow-y-auto"></div>
                <div class="mt-3 flex justify-center">
                    <button id="executeBot5Results" class="w-8 h-8 bg-teal-600 text-white rounded-full hover:bg-teal-700 transition-colors text-sm font-bold flex items-center justify-center">
                        5
                    </button>
                </div>
            </div>

            <div class="bg-indigo-50 dark:bg-indigo-900/20 rounded-lg p-6">
                <h3 class="text-lg font-semibold flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <span class="w-8 h-8 bg-indigo-500 text-white rounded-full flex items-center justify-center text-sm mr-3">6</span>
                        🎯 Dynamic SST Generator Bot
                        <div class="ml-4 flex items-center space-x-2">
                            <input 
                                type="text" 
                                id="bot6PromptSearch" 
                                class="w-16 px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-xs"
                                placeholder="ID"
                            >
                            <button 
                                id="loadBot6Prompt"
                                class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-xs"
                                disabled
                            >
                                Load
                            </button>
                            <button 
                                id="randomBot6Prompt"
                                class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 transition-colors text-xs"
                                disabled
                                title="Random Prompt"
                            >
                                🎲
                            </button>
                        </div>
                    </div>
                    <div class="flex space-x-1 items-center">
                        <label class="flex items-center cursor-pointer" title="Mark as Complete">
                            <input type="checkbox" id="manualCompleteBot6" class="mr-1">
                            <span class="text-xs text-gray-500">✓ Done</span>
                        </label>
                        <button id="resetBot6" class="p-1 text-orange-400 hover:text-orange-600 dark:hover:text-orange-300" title="Reset Bot State">🔄</button>
                        <button id="copyBot6" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Copy to Clipboard">📋</button>
                        <button id="downloadBot6" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Download as Markdown">💾</button>
                        <button id="feedBot6" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Feed to Preview">📤</button>
                        <button id="clearBot6" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300" title="Clear Output">🗑️</button>
                    </div>
                </h3>
                <div class="mb-2 flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <span class="text-xs text-gray-500">Model:</span>
                        <span id="bot6ModelDisplay" class="text-xs font-mono bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded">Choose model</span>
                    </div>
                    <div id="bot6PromptStatus" class="text-xs text-gray-500">Default prompt</div>
                </div>
                <div class="mt-2">
                    <details class="group">
                        <summary id="bot6-injection-summary" class="text-xs text-gray-500 dark:text-gray-400 cursor-pointer select-none group-open:mb-2 hover:text-gray-700 dark:hover:text-gray-200">
                            ➕ Add Custom Instruction
                        </summary>
                        <div class="flex items-center space-x-2">
                            <textarea 
                                id="bot6-custom-instruction" 
                                class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-sm resize-none"
                                rows="2"
                                placeholder="e.g., 'Focus only on Article 17(1)(a)...'"
                            ></textarea>
                            <button id="inject-instruction-bot6" class="px-3 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors text-xs">
                                Inject
                            </button>
                            <button id="clear-instruction-bot6" class="px-3 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors text-xs hidden">
                                Clear
                            </button>
                        </div>
                    </details>
                </div>
                <div id="bot6Status" class="text-sm text-gray-600 dark:text-gray-400 mb-2"></div>
                <div id="bot6Output" class="prose dark:prose-invert max-w-none bg-white dark:bg-gray-800 p-4 rounded border min-h-[50px] max-h-[600px] overflow-y-auto"></div>
                <div class="mt-3 flex justify-center">
                    <button id="executeBot6Results" class="w-8 h-8 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition-colors text-sm font-bold flex items-center justify-center">
                        6
                    </button>
                </div>
            </div>
        </div>

        </div>

        <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mt-6">
            <div class="flex items-center justify-between cursor-pointer" id="loggingToggle">
                <div class="flex items-center">
                    <span id="loggingArrow" class="text-xl mr-2 transform transition-transform duration-200">▼</span>
                    <h2 class="text-xl font-semibold">📊 Live Activity Log</h2>
                    <span id="logCount" class="ml-2 px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 text-xs rounded-full">0 activities</span>
                </div>
                
                <div class="flex items-center space-x-3 text-sm">
                    <div class="flex items-center space-x-2">
                        <label class="text-gray-600 dark:text-gray-400">Font:</label>
                        <select id="loggingFont" class="px-2 py-1 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-xs">
                            <option value="ui-sans-serif">Default</option>
                            <option value="ui-serif">Serif</option>
                            <option value="ui-monospace">Mono</option>
                            <option value="Georgia">Georgia</option>
                            <option value="Times">Times</option>
                            <option value="Courier">Courier</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <label class="text-gray-600 dark:text-gray-400">Size:</label>
                        <select id="loggingSize" class="px-2 py-1 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-xs">
                            <option value="text-xs">XS</option>
                            <option value="text-sm" selected>SM</option>
                            <option value="text-base">Base</option>
                            <option value="text-lg">LG</option>
                            <option value="text-xl">XL</option>
                        </select>
                    </div>
                    
                    <button id="clearAllLogs" class="px-3 py-1 bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 rounded text-xs hover:bg-red-200 dark:hover:bg-red-800" title="Clear All Logs">
                        🗑️ Clear Logs
                    </button>
                </div>
            </div>
            
            <div id="loggingContent" class="mt-4 space-y-2 max-h-[70vh] overflow-y-auto">
                <div id="loggingEmpty" class="text-gray-500 dark:text-gray-400 text-center py-8 italic">
                    No activity logged yet. Bot executions will appear here in real-time.
                </div>
            </div>
        </div>

        <div id="errorSection" class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 mt-6">
            <h3 class="text-red-800 dark:text-red-200 font-semibold mb-2">❌ Error</h3>
            <div id="errorMessage" class="text-red-700 dark:text-red-300"></div>
        </div>
    </div>

    <script>
        // ===== CENTRAL STATE MANAGEMENT =====
        window.DRBangerState = {};

        // ===== EVENT LISTENER MANAGEMENT SYSTEM =====
        const eventListenerRegistry = new Map();
        let initializationCount = 0;
        
        function addManagedEventListener(element, event, handler, description = '') {
            if (!element) {
                console.warn(`[DRBanger] Cannot add listener to null element: ${description}`);
                return;
            }
            
            const elementId = element.id || element.tagName || 'unknown';
            const listenerKey = `${elementId}-${event}-${initializationCount}`;
            
            // Add the listener
            element.addEventListener(event, handler);
            
            // Track it for cleanup
            eventListenerRegistry.set(listenerKey, {
                element,
                event,
                handler,
                description,
                added: new Date().toISOString()
            });
            
            console.log(`[DRBanger] Registered listener: ${listenerKey} - ${description}`);
        }
        
        function cleanupManagedListeners() {
            console.log(`[DRBanger] Cleaning up ${eventListenerRegistry.size} managed event listeners...`);
            
            let cleanedCount = 0;
            eventListenerRegistry.forEach((listener, key) => {
                try {
                    if (listener.element && listener.handler) {
                        listener.element.removeEventListener(listener.event, listener.handler);
                        cleanedCount++;
                    }
                } catch (error) {
                    console.warn(`[DRBanger] Error cleaning listener ${key}:`, error);
                }
            });
            
            eventListenerRegistry.clear();
            console.log(`[DRBanger] Cleaned ${cleanedCount} event listeners successfully`);
            return cleanedCount;
        }
        
        function getMemoryUsageReport() {
            let activeSelectorsCount = 0;
            try {
                activeSelectorsCount = botSelectors ? botSelectors.length : 0;
            } catch (e) {
                // botSelectors not yet declared - that's fine
                activeSelectorsCount = 0;
            }
            
            const report = {
                managedListeners: eventListenerRegistry.size,
                initializationCount,
                activeSelectors: activeSelectorsCount,
                logEntries: logEntries ? logEntries.length : 0,
                streamingLogs: streamingLogs ? Object.keys(streamingLogs).length : 0
            };
            
            console.log('[DRBanger] Memory Usage Report:', report);
            return report;
        }

        // ===== MASSIVE MODEL DATABASE =====
        const multimodalModels = {
            "Favorites": [
                "@GPT-5",
                "@GPT-4.1",
                "@o3-pro",
                "@o1",
                "@Gemini-2.5-Pro",
                "@Claude-Opus-4-Reasoning",
                "@Claude-Opus-4.1",
                "@Claude-Opus-4-Search",
                "@Claude-Sonnet-4-Search",
                "@Grok-4",
                "@Mistral-Large-2"
            ],
            "Web Search": [
                "@Claude-Opus-4-Search",
                "@Claude-Sonnet-4-Search",
                "@Gemini-2.5-Flash",
                "@Gemini-2.5-Pro",
                "@Grok-4",
                "@Perplexity-Sonar",
                "@Perplexity-Sonar-Rsn-Pro",
                "@GPT-4o-Search",
                "@Linkup-Deep-Search"   
            ],
            "GPT": {
                "GPT-5 Series": [
                    "@GPT-5-Chat",
                    "@GPT-5",
                    "@GPT-5-mini",
                    "@GPT-5-nano"
                ],
                "GPT-4 Series": [
                    "@GPT-4.1",
                    "@GPT-4o-Search",
                    "@GPT-4-Classic",
                    "@GPT-4-Classic-0314",
                    "@GPT-4-Turbo",
                    "@GPT-4.1-mini",
                    "@GPT-4.1-nano",
                    "@GPT-4o",
                    "@GPT-4o-mini",
                    "@GPT-4o-mini-Search",
                    "@GPT-4o-Aug"
                ],
                "GPT-3.5 Series": [
                    "@GPT-3.5-Turbo",
                    "@GPT-3.5-Turbo-Instruct",
                    "@GPT-3.5-Turbo-Raw"
                ],
                "o-Series (Reasoning)": [
                    "@o1",
                    "@o3",
                    "@o3-pro",
                    "@o1-mini",
                    "@o3-mini",
                    "@o3-mini-high",
                    "@o4-mini",
                    "@o3-Pro"
                ]
            },
            "GPT - Open Weight": {
                "120B Parameter Models": [
                    "@GPT-OSS-120B-T",
                    "@GPT-OSS-120B",
                    "@GPT-OSS-120B-CS",
                    "@OpenAI-GPT-OSS-120B"
                ],
                "20B Parameter Models": [
                    "@GPT-OSS-20B-T",
                    "@GPT-OSS-20B",
                    "@OpenAI-GPT-OSS-20B"
                ]
            },
            "Google": {
                "Gemini 2.5 Series": [
                    "@Gemini-2.5-Pro",
                    "@Gemini-2.5-Flash",
                    "@Gemini-2.5-Flash-Lite",
                    "@Gemini-2.5-Flash-Image"
                ],
                "Gemini 2.0 Series": [
                    "@Gemini-2.0-Flash",
                    "@Gemini-2.0-Flash-Lite",
                    "@Gemini-2.0-Flash-Preview"
                ],
                "Gemini 1.5 Series": [
                    "@Gemini-1.5-Pro",
                    "@Gemini-1.5-Pro-Search",
                    "@Gemini-1.5-Flash",
                    "@Gemini-1.5-Flash-Search"
                ],
                "Gemma Series": [
                    "@Gemma-3-27B",
                    "@Gemma-2-27b-T"
                ]
            },
            "Claude": {
                "Opus Series": [
                    "@Claude-Opus-4.1",
                    "@Claude-Opus-4",
                    "@Claude-Opus-4-Reasoning",
                    "@Claude-Opus-4-Search",
                    "@Claude-Opus-3"
                ],
                "Sonnet Series": [
                    "@Claude-Sonnet-4",
                    "@Claude-Sonnet-4-Reasoning",
                    "@Claude-Sonnet-4-Search",
                    "@Claude-Sonnet-3.5",
                    "@Claude-Sonnet-3.5-June",
                    "@Claude-Sonnet-3.5-Search",
                    "@Claude-Sonnet-3.7",
                    "@Claude-Sonnet-3.7-Reasoning",
                    "@Claude-Sonnet-3.7-Search"
                ],
                "Haiku Series": [
                    "@Claude-Haiku-3.5",
                    "@Claude-Haiku-3",
                    "@Claude-Haiku-3.5-Search"
                ]
            },
            "Grok": [
                "@Grok-4",
                "@Grok-3",
                "@Grok-3-Mini",
                "@Grok-Code-Fast-1",
                "@Grok-2"
            ],
            "Llama 4": [
                "@Llama-4-Scout-B10",
                "@Llama-4-Maverick",
                "@Llama-4-Scout-T",
                "@Llama-4-Scout-CS",
                "@Llama-4-Scout",
                "@Llama-4-Maverick-T",
                "@Llama-4-Maverick-B10"
            ],
            "Llama 3.X": {
                "The Behemoths (405B)": [
                    "@Llama-3.1-405B",
                    "@Llama-3.1-405B-T",
                    "@Llama-3.1-405B-FW",
                    "@Llama-3.1-405B-FP16"
                ],
                "The Curated 70B Fleet": [
                    "@Llama-3-70b-Groq",
                    "@Llama-3.3-70B",
                    "@Llama-3.1-Nemotron",
                    "@Llama-3.3-70B-DI",
                    "@Llama-3.3-70B-CS",
                    "@Llama-3.3-70B-Vers",
                    "@Llama-3-70B-FP16",
                    "@Llama-3-70B-T",
                    "@Llama-3.1-70B",
                    "@Llama-3.1-70B-FP16",
                    "@Llama-3.1-70B-FW",
                    "@Llama-3.1-70B-T",
                    "@Llama-3.3-70B-FW",
                    "@Llama-3.3-70B-N"
                ],
                "The 8B Fleet": [
                    "@Llama-3-8B-T",
                    "@Llama-3-8b-Groq",
                    "@Llama-3.1-8B",
                    "@Llama-3.1-8B-CS",
                    "@Llama-3.1-8B-DI",
                    "@Llama-3.1-8B-FP16",
                    "@Llama-3.1-8B-FW",
                    "@Llama-3.1-8B-T-128k"
                ]
            },
            "Qwen (235B+)": {
                "480B": [
                    "@Qwen3-480B-Coder-CS",
                    "@Qwen3-Coder-480B-T",
                    "@Qwen3-Coder-480B-N"
                ],
                "235B": [
                    "@Qwen-3-235B-2507-T",
                    "@Qwen3-235B-2507-FW",
                    "@Qwen3-235B-2507-CS",
                    "@Qwen3-235B-A22B",
                    "@Qwen3-235B-A22B-DI",
                    "@Qwen3-235B-A22B-N",
                    "@Qwen3-235B-Think-CS"
                ],
                "72B": [
                    "@Qwen-72B-T",
                    "@Qwen2-72B-Instruct-T",
                    "@Qwen2.5-VL-72B-T",
                    "@Qwen-2.5-72B-T"
                ],
                "30–32B": [
                    "@Qwen3-30B-A3B-Instruct",
                    "@Qwen2.5-Coder-32B",
                    "@Qwen2.5-Coder-32B-T",
                    "@Qwen3-32B-CS",
                    "@Qwen3-Coder-30B-A3B"
                ],
                "≤32B & VL": [
                    "@Qwen-2.5-7B-T",
                    "@Qwen-2.5-VL-32b"
                ],
                "General": [
                    "@Qwen3-Coder"
                ]
            },
            "DeepSeek": {
                "R1 Series (Reasoning)": [
                    "@DeepSeek-R1",
                    "@DeepSeek-R1-FW",
                    "@DeepSeek-R1-DI",
                    "@DeepSeek-R1-N",
                    "@DeepSeek-R1-Distill",
                    "@DeepSeek-R1-Turbo-DI"
                ],
                "V3 Series (Foundation)": [
                    "@DeepSeek-V3.1",
                    "@DeepSeek-V3.1-N",
                    "@Deepseek-V3-FW",
                    "@DeepSeek-V3",
                    "@DeepSeek-V3-DI",
                    "@DeepSeek-V3-Turbo-DI"
                ],
                "Specialized & Hybrids": [
                    "@DeepSeek-Prover-V2",
                    "@DeepClaude"
                ]
            },
            "Mistral": {
                "Large Series": [
                    "@Mistral-Large-2"
                ],
                "Medium Series": [
                    "@Mistral-Medium-3",
                    "@Mistral-Medium",
                    "@Magistral-Medium-2506-Thinking"
                ],
                "Small Series (Vision-Enabled)": [
                    "@Mistral-Small-3.2",
                    "@Mistral-Small-3.1",
                    "@Mistral-Small-3",
                    "@Mistral-7B-v0.3-DI",
                    "@Mistral-7B-v0.3-T"
                ],
                "Specialized & MoE Models": [
                    "@Mistral-NeMo",
                    "@Mixtral8x22b-Inst-FW"
                ]
            },
            "Perplexity": [
                "@Perplexity-R1-1776",
                "@Perplexity-Sonar",
                "@Perplexity-Sonar-Pro",
                "@Perplexity-Sonar-Rsn",
                "@Perplexity-Sonar-Rsn-Pro"
            ],
            "Wildcards (A-K)": [
                "@Aya-Expanse-32B",
                "@Aya-Vision",
                "@Command-R",
                "@Command-R-Plus",
                "@GLM-4.5",
                "@GLM-4.5-Air",
                "@GLM-4.5-Air-T",
                "@GLM-4.5-FW",
                "@Inception-Mercury",
                "@Inception-Mercury-Coder",
                "@Bagoodex-Web-Search",
                "@Hermes-3-70B",
                "@Kimi-K2",
                "@Kimi-K2-Instruct",
                "@Kimi-K2-T"
            ],
            "Wildcards (L-Z)": [
                "@Linkup-Standard",
                "@MiniMax-M1",
                "@Phi-4-DI",
                "@QwQ-32B-B10",
                "@QwQ-32B-Preview-T",
                "@QwQ-32B-T",
                "@Reka-Core",
                "@Reka-Flash",
                "@Reka-Research",
                "@Tako",
                "@Solar-Pro-2"
            ]
        };

        // State for model selections
        let selectedBotModels = ['', '', '', '', '', ''];

        // ===== ACCORDION MODEL SELECTOR CLASS =====
        class AccordionModelSelector {
            constructor(botId) {
                this.botId = botId;
                this.selectedModel = '';
                this.container = document.getElementById(`accordion-root-${botId}`);
                this.selectorContainer = document.getElementById(`selector-container-${botId}`);
                this.searchInput = document.getElementById(`model-search-${botId}`);
                this.clearBtn = document.getElementById(`clear-btn-${botId}`);
                this.isCollapsed = true;
                this.searchTerm = '';
                this.currentData = multimodalModels;
                this.highlightedIndex = -1;
                this.init();
            }

            init() {
                this.render();
                this.attachEventListeners();
                this.selectorContainer.classList.add('collapsed');
                this.bindSearchInput();
            }

            bindSearchInput() {
                const input = this.searchInput;
                if (!input) return;
                const stop = (e) => { e.stopPropagation(); e.stopImmediatePropagation(); };
                input.addEventListener('click', stop);
                input.addEventListener('mousedown', stop);
                input.addEventListener('pointerdown', stop);
                input.addEventListener('touchstart', (e) => { stop(e); input.focus(); }, { passive: false });

                input.addEventListener('input', (e) => {
                    const currentValue = (e.target.value || '').trim();
                    this.searchTerm = currentValue;
                    
                    // If user is typing something different from selected model, auto-clear selection
                    if (this.selectedModel && currentValue !== this.selectedModel && currentValue !== '') {
                        this.autoClearSelection();
                    }
                    
                    this.applySearch();
                    // Auto-expand to show matches when typing
                    if (this.isCollapsed && this.searchTerm) this.expand();
                    // Reset keyboard navigation when search changes
                    this.highlightedIndex = -1;
                    this.updateHighlight();
                });
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        input.value = '';
                        this.searchTerm = '';
                        this.applySearch();
                        this.highlightedIndex = -1;
                        this.updateHighlight();
                    } else if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        if (this.isCollapsed) this.expand();
                        this.navigateDown();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        if (this.isCollapsed) this.expand();
                        this.navigateUp();
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (this.highlightedIndex >= 0) {
                            this.selectHighlightedModel();
                        }
                    }
                });
                
                // Add focus behavior to make it clear the input is editable
                input.addEventListener('focus', (e) => {
                    if (this.selectedModel) {
                        input.select(); // Select all text to make editing easier
                    }
                    if (this.isCollapsed) this.expand();
                });
            }

            sanitizeId(str) {
                return str.replace(/[^a-zA-Z0-9-]/g, '-').toLowerCase();
            }

            render(data = this.currentData) {
                this.currentData = data;
                let html = '';
                
                Object.entries(data).forEach(([provider, pdata]) => {
                    const providerId = this.sanitizeId(provider);
                    const modelCount = this.countModels(pdata);
                    
                    html += `
                        <div class="accordion-item">
                            <div class="accordion-header" data-provider="${providerId}">
                                <span class="accordion-title">${provider}</span>
                                <span style="display: flex; align-items: center; gap: 6px;">
                                    <span class="model-count">${modelCount}</span>
                                    <svg class="accordion-icon" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                </span>
                            </div>
                            <div class="accordion-content" id="content-${providerId}-${this.botId}">
                                ${this.renderSeries(pdata, providerId)}
                            </div>
                        </div>
                    `;
                });
                
                this.container.innerHTML = html;

                // Auto-expand when searching so results are visible
                if (this.searchTerm) {
                    this.container.querySelectorAll('.accordion-header').forEach(h => h.classList.add('active'));
                    this.container.querySelectorAll('.accordion-content').forEach(c => c.classList.add('active'));
                    this.container.querySelectorAll('.series-header').forEach(h => h.classList.add('active'));
                    this.container.querySelectorAll('.series-content').forEach(c => c.classList.add('active'));
                }

                // Re-apply selected highlight and reflect value
                if (this.selectedModel) {
                    const sel = this.container.querySelector(`.model-item[data-model="${CSS.escape(this.selectedModel)}"]`);
                    if (sel) sel.classList.add('selected');
                    if (this.searchInput) this.searchInput.value = this.selectedModel;
                } else {
                    if (this.searchInput && !this.searchTerm) {
                        this.searchInput.value = '';
                        this.searchInput.placeholder = 'Search or select model...';
                    }
                }
            }

            renderSeries(data, providerId) {
                let html = '';
                
                if (Array.isArray(data)) {
                    const list = this.sortModels(data);
                    list.forEach(model => {
                        const modelId = this.sanitizeId(model);
                        html += `
                            <div class="model-item" data-model="${model}" data-model-id="${modelId}">
                                ${model}
                            </div>
                        `;
                    });
                } else {
                    Object.entries(data).forEach(([series, models]) => {
                        const seriesId = this.sanitizeId(series);
                        
                        if (models.length === 0) {
                            html += `
                                <div class="series-item">
                                    <div class="series-header" style="color: var(--text-secondary); font-style: italic;">
                                        <span>${series} (empty)</span>
                                    </div>
                                </div>
                            `;
                        } else {
                            const list = this.sortModels(models);
                            html += `
                                <div class="series-item">
                                    <div class="series-header" data-series="${seriesId}">
                                        <span>${series}</span>
                                        <span style="display: flex; align-items: center; gap: 6px;">
                                            <span class="model-count">${list.length}</span>
                                            <svg class="accordion-icon" style="width: 14px; height: 14px;" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                                            </svg>
                                        </span>
                                    </div>
                                    <div class="series-content" id="series-${seriesId}-${this.botId}">
                                        ${list.map(model => {
                                            const modelId = this.sanitizeId(model);
                                            return `
                                                <div class="model-item" data-model="${model}" data-model-id="${modelId}">
                                                    ${model}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        }
                    });
                }
                
                return html;
            }

            normalizeName(name) {
                return (name || '').replace(/^@/, '').toLowerCase();
            }

            sortModels(models) {
                let list = Array.from(models);
                if (!this.searchTerm) {
                    return list.sort((a, b) => this.normalizeName(a).localeCompare(this.normalizeName(b)));
                }
                const term = this.searchTerm.toLowerCase();
                const starts = [];
                const contains = [];
                list.forEach(m => {
                    const n = this.normalizeName(m);
                    if (n.startsWith(term)) starts.push(m);
                    else if (n.includes(term)) contains.push(m);
                });
                starts.sort((a, b) => this.normalizeName(a).localeCompare(this.normalizeName(b)));
                contains.sort((a, b) => this.normalizeName(a).localeCompare(this.normalizeName(b)));
                return [...starts, ...contains];
            }

            getFilteredData() {
                const term = this.searchTerm.toLowerCase();
                if (!term) return multimodalModels;
                const out = {};
                Object.entries(multimodalModels).forEach(([provider, pdata]) => {
                    if (Array.isArray(pdata)) {
                        const filtered = pdata.filter(m => this.normalizeName(m).includes(term));
                        if (filtered.length) out[provider] = filtered;
                    } else {
                        const seriesOut = {};
                        Object.entries(pdata).forEach(([series, models]) => {
                            const filtered = models.filter(m => this.normalizeName(m).includes(term));
                            if (filtered.length) seriesOut[series] = filtered;
                        });
                        if (Object.keys(seriesOut).length) out[provider] = seriesOut;
                    }
                });
                return out;
            }

            applySearch() {
                const data = this.getFilteredData();
                this.render(data);
            }

            countModels(data) {
                if (Array.isArray(data)) {
                    return data.length;
                }
                
                let count = 0;
                Object.values(data).forEach(models => {
                    if (Array.isArray(models)) {
                        count += models.length;
                    } else if (typeof models === 'object' && models !== null) {
                        // Handle nested structure like Qwen series
                        Object.values(models).forEach(nestedModels => {
                            if (Array.isArray(nestedModels)) {
                                count += nestedModels.length;
                            }
                        });
                    }
                });
                return count;
            }

            attachEventListeners() {
                this.container.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    const header = e.target.closest('.accordion-header');
                    if (header) {
                        this.toggleAccordionSection(header);
                        return;
                    }
                    
                    const seriesHeader = e.target.closest('.series-header');
                    if (seriesHeader && seriesHeader.dataset.series) {
                        this.toggleSeries(seriesHeader);
                        return;
                    }
                    
                    const modelItem = e.target.closest('.model-item');
                    if (modelItem) {
                        this.selectModel(modelItem);
                        return;
                    }
                });
            }

            toggleAccordionSection(header) {
                const providerId = header.dataset.provider;
                const content = document.getElementById(`content-${providerId}-${this.botId}`);
                const isActive = header.classList.contains('active');
                
                this.container.querySelectorAll('.accordion-header').forEach(h => {
                    h.classList.remove('active');
                });
                this.container.querySelectorAll('.accordion-content').forEach(c => {
                    c.classList.remove('active');
                });
                
                if (!isActive) {
                    header.classList.add('active');
                    content.classList.add('active');
                }
            }

            toggleSeries(header) {
                const seriesId = header.dataset.series;
                const content = document.getElementById(`series-${seriesId}-${this.botId}`);
                const isActive = header.classList.contains('active');
                
                const provider = header.closest('.accordion-content');
                provider.querySelectorAll('.series-header').forEach(h => {
                    h.classList.remove('active');
                });
                provider.querySelectorAll('.series-content').forEach(c => {
                    c.classList.remove('active');
                });
                
                if (!isActive) {
                    header.classList.add('active');
                    content.classList.add('active');
                }
            }

            selectModel(modelItem) {
                const model = modelItem.dataset.model;
                
                this.container.querySelectorAll('.model-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                modelItem.classList.add('selected');
                this.selectedModel = model;
                
                // Update the global bot model state
                const botIndex = parseInt(this.botId.replace('bot', '')) - 1;
                selectedBotModels[botIndex] = model;
                
                if (this.searchInput) {
                    this.searchInput.value = model;
                    this.searchTerm = '';
                }
                this.updateClearButtonVisibility();
                this.highlightedIndex = -1; // Reset keyboard navigation
                this.collapse(); // Close accordion after selection
                
                console.log(`[DRBanger] ${this.botId} selected model: ${model}`);
            }

            collapse() {
                this.isCollapsed = true;
                this.selectorContainer.classList.add('collapsed');
                
                this.container.querySelectorAll('.accordion-header').forEach(h => {
                    h.classList.remove('active');
                });
                this.container.querySelectorAll('.accordion-content').forEach(c => {
                    c.classList.remove('active');
                });
                this.container.querySelectorAll('.series-header').forEach(h => {
                    h.classList.remove('active');
                });
                this.container.querySelectorAll('.series-content').forEach(c => {
                    c.classList.remove('active');
                });
            }

            expand() {
                this.isCollapsed = false;
                this.selectorContainer.classList.remove('collapsed');
            }

            autoClearSelection() {
                // Clear selection without resetting search input
                this.selectedModel = '';
                const botIndex = parseInt(this.botId.replace('bot', '')) - 1;
                selectedBotModels[botIndex] = '';
                this.container.querySelectorAll('.model-item').forEach(item => {
                    item.classList.remove('selected');
                });
                this.updateClearButtonVisibility();
            }

            updateClearButtonVisibility() {
                if (this.clearBtn) {
                    this.clearBtn.style.display = this.selectedModel ? 'inline-block' : 'none';
                }
            }

            getVisibleModelItems() {
                return Array.from(this.container.querySelectorAll('.model-item')).filter(item => {
                    // Check if the item is actually visible (not in a collapsed section)
                    let parent = item.closest('.series-content');
                    if (parent && !parent.classList.contains('active')) return false;
                    
                    parent = item.closest('.accordion-content');
                    if (parent && !parent.classList.contains('active')) return false;
                    
                    return true;
                });
            }

            navigateDown() {
                const visibleItems = this.getVisibleModelItems();
                if (visibleItems.length === 0) return;
                
                this.highlightedIndex = Math.min(this.highlightedIndex + 1, visibleItems.length - 1);
                this.updateHighlight();
                this.scrollToHighlighted();
            }

            navigateUp() {
                const visibleItems = this.getVisibleModelItems();
                if (visibleItems.length === 0) return;
                
                if (this.highlightedIndex === -1) {
                    this.highlightedIndex = visibleItems.length - 1;
                } else {
                    this.highlightedIndex = Math.max(this.highlightedIndex - 1, 0);
                }
                this.updateHighlight();
                this.scrollToHighlighted();
            }

            updateHighlight() {
                // Remove all highlights
                this.container.querySelectorAll('.model-item').forEach(item => {
                    item.classList.remove('highlighted');
                });
                
                // Add highlight to current item
                const visibleItems = this.getVisibleModelItems();
                if (this.highlightedIndex >= 0 && this.highlightedIndex < visibleItems.length) {
                    visibleItems[this.highlightedIndex].classList.add('highlighted');
                }
            }

            scrollToHighlighted() {
                const visibleItems = this.getVisibleModelItems();
                if (this.highlightedIndex >= 0 && this.highlightedIndex < visibleItems.length) {
                    const item = visibleItems[this.highlightedIndex];
                    const wrapper = this.container.closest('.accordion-wrapper');
                    if (wrapper) {
                        const itemRect = item.getBoundingClientRect();
                        const wrapperRect = wrapper.getBoundingClientRect();
                        
                        if (itemRect.bottom > wrapperRect.bottom) {
                            wrapper.scrollTop += itemRect.bottom - wrapperRect.bottom + 5;
                        } else if (itemRect.top < wrapperRect.top) {
                            wrapper.scrollTop -= wrapperRect.top - itemRect.top + 5;
                        }
                    }
                }
            }

            selectHighlightedModel() {
                const visibleItems = this.getVisibleModelItems();
                if (this.highlightedIndex >= 0 && this.highlightedIndex < visibleItems.length) {
                    this.selectModel(visibleItems[this.highlightedIndex]);
                }
            }

            clearSelection() {
                this.selectedModel = '';
                const botIndex = parseInt(this.botId.replace('bot', '')) - 1;
                selectedBotModels[botIndex] = '';
                this.container.querySelectorAll('.model-item').forEach(item => {
                    item.classList.remove('selected');
                });
                if (this.searchInput) this.searchInput.value = '';
                this.searchTerm = '';
                this.highlightedIndex = -1;
                this.applySearch();
                this.updateClearButtonVisibility();
                this.collapse();
                console.log(`[DRBanger] ${this.botId} selection cleared`);
            }
        }

        // ===== PREVIEW SETTINGS =====
        let previewSettings = {
            font: 'ui-sans-serif',
            size: 'text-sm',
            theme: 'default'
        };

        // ===== SAFE JSON PARSING UTILITY =====
        function safeJsonParse(jsonString, context = 'JSON') {
            try {
                if (typeof jsonString !== 'string') {
                    throw new Error('Input is not a string');
                }
                
                // Check for obviously malicious content
                if (jsonString.includes('<script') || jsonString.includes('javascript:')) {
                    throw new Error('Potentially dangerous content detected');
                }
                
                // Parse with size limit (10MB)
                if (jsonString.length > 10 * 1024 * 1024) {
                    throw new Error('JSON too large (>10MB)');
                }
                
                const parsed = JSON.parse(jsonString);
                console.log(`[DRBanger] ${context} parsed successfully`);
                return parsed;
                
            } catch (error) {
                console.error(`[DRBanger] ${context} parsing error:`, error);
                showErrorToast(`${context} error: ${error.message}`);
                return null;
            }
        }

        // ===== ERROR HANDLING SYSTEM =====
        function showErrorToast(message) {
            console.error('[DRBanger Error]:', message);
            const toast = document.getElementById('errorToast');
            const toastMessage = document.getElementById('errorToastMessage');
            
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 5000);
        }

        function showStateToast(message) {
            console.log('[DRBanger State]:', message);
            const toast = document.getElementById('stateToast');
            const toastMessage = document.getElementById('stateToastMessage');
            
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function showError(message) {
            showErrorToast(message);
            // Also log to old error system for fallback
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorSection').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('errorSection').classList.add('hidden');
            }, 5000);
        }

        // ===== PHASE 5: STATE MANAGEMENT SYSTEM =====
        
        function captureCurrentState() {
            const state = {
                version: "2.1-InjectionEnabled",
                timestamp: new Date().toISOString(),
                phase: "Enhanced State Management",
                
                // Inputs
                inputs: {
                    legalText: document.getElementById('legalText').value,
                    sstCapsule: document.getElementById('sstCapsule').value,
                    customDomain: document.getElementById('customDomain').value,
                    customInstruction: document.getElementById('customInstruction').value
                },
                
                // Bot model selections from accordion selectors
                botModelSelections: selectedBotModels,
                
                // Bot outputs and statuses
                botResults: {},
                
                // Workflow progress
                workflowProgress: {},
                
                // SST Database
                sstDatabase: sstDatabase,
                sstDatabaseStatus: document.getElementById('sstDatabaseStatus') ? {
                    text: document.getElementById('sstDatabaseStatus').textContent,
                    className: document.getElementById('sstDatabaseStatus').className
                } : null,
                
                // Legal Text Database
                legalTextDatabase: legalTextDatabase,
                
                // Bot Prompts Database
                botPromptsDatabase: botPromptsDatabase,
                customPrompts: customPrompts,
                
                injectedInstructions: injectedInstructions,
                
                // Workflow state
                currentWorkflowBot: currentWorkflowBot,
                workflowRunning: workflowRunning
            };
            
            // Capture bot results
            for (let i = 1; i <= 6; i++) {
                const output = document.getElementById(`bot${i}Output`);
                const status = document.getElementById(`bot${i}Status`);
                
                state.botResults[`bot${i}`] = {
                    output: output ? output.innerHTML : '',
                    status: status ? status.textContent : '',
                    statusClassName: status ? status.className : ''
                };
            }
            
            // Capture workflow progress
            for (let i = 1; i <= 6; i++) {
                const stepStatus = document.getElementById(`step${i}Status`);
                if (stepStatus) {
                    state.workflowProgress[`step${i}`] = {
                        text: stepStatus.textContent,
                        className: stepStatus.className
                    };
                }
            }
            
            return state;
        }

        function restoreState(state) {
            try {
                console.log('[DRBanger] Restoring state:', state);
                
                // Restore inputs
                if (state.inputs) {
                    if (state.inputs.legalText !== undefined) {
                        document.getElementById('legalText').value = state.inputs.legalText;
                    }
                    if (state.inputs.sstCapsule !== undefined) {
                        document.getElementById('sstCapsule').value = state.inputs.sstCapsule;
                    }
                    if (state.inputs.customDomain !== undefined) {
                        document.getElementById('customDomain').value = state.inputs.customDomain;
                    }
                    if (state.inputs.customInstruction !== undefined) {
                        document.getElementById('customInstruction').value = state.inputs.customInstruction;
                    }
                }
                
                // Restore bot selections
                if (state.botSelections) {
                    for (let i = 1; i <= 6; i++) {
                        const botSelect = document.getElementById(`bot${i}`);
                        if (botSelect && state.botSelections[`bot${i}`]) {
                            botSelect.value = state.botSelections[`bot${i}`];
                        }
                    }
                }
                
                // Restore bot results
                if (state.botResults) {
                    for (let i = 1; i <= 6; i++) {
                        const outputDiv = document.getElementById(`bot${i}Output`);
                        const statusDiv = document.getElementById(`bot${i}Status`);
                        const botResult = state.botResults[`bot${i}`];
                        
                        if (outputDiv && botResult) {
                            outputDiv.innerHTML = botResult.output || '';
                            if (statusDiv) {
                                statusDiv.textContent = botResult.status || '';
                                statusDiv.className = botResult.statusClassName || 'text-sm text-gray-600 dark:text-gray-400 mb-2';
                            }
                        }
                    }
                }
                
                // Restore workflow progress
                if (state.workflowProgress) {
                    for (let i = 1; i <= 6; i++) {
                        const stepStatus = document.getElementById(`step${i}Status`);
                        const stepData = state.workflowProgress[`step${i}`];
                        
                        if (stepStatus && stepData) {
                            stepStatus.textContent = stepData.text;
                            stepStatus.className = stepData.className;
                        }
                    }
                }
                
                // Restore Injected Instructions and update UI
                if (state.injectedInstructions) {
                    injectedInstructions = state.injectedInstructions;
                    for (let i = 1; i <= 6; i++) {
                        const instruction = injectedInstructions[i];
                        const instructionBox = document.getElementById(`bot${i}-custom-instruction`);
                        const summary = document.getElementById(`bot${i}-injection-summary`);
                        const clearBtn = document.getElementById(`clear-instruction-bot${i}`);

                        if (instructionBox && summary && clearBtn) {
                            if (instruction) {
                                instructionBox.value = instruction;
                                summary.innerHTML = '✅ Custom Instruction Injected!';
                                summary.classList.add('text-green-600', 'dark:text-green-400');
                                clearBtn.classList.remove('hidden');
                            } else {
                                instructionBox.value = '';
                                summary.innerHTML = '➕ Add Custom Instruction';
                                summary.classList.remove('text-green-600', 'dark:text-green-400');
                                clearBtn.classList.add('hidden');
                            }
                        }
                    }
                }
                
                // Restore SST Database
                if (state.sstDatabase) {
                    sstDatabase = state.sstDatabase;
                    const statusElement = document.getElementById('sstDatabaseStatus');
                    if (state.sstDatabaseStatus && statusElement) {
                        statusElement.textContent = state.sstDatabaseStatus.text;
                        statusElement.className = state.sstDatabaseStatus.className;
                    }
                    initializeCascadingDropdowns();
                }
                
                // Preview system removed - keeping settings for compatibility
                if (state.previewSettings) {
                    previewSettings = state.previewSettings;
                }
                
                // Preview items no longer used - converted to logging
                
                console.log('[DRBanger] State restored successfully');
                return true;
                
            } catch (error) {
                console.error('[DRBanger] Error restoring state:', error);
                return false;
            }
        }

        function saveState() {
            try {
                const state = captureCurrentState();
                const stateJson = JSON.stringify(state, null, 2);
                
                navigator.clipboard.writeText(stateJson).then(() => {
                    console.log('[DRBanger] State saved to clipboard');
                    showStateToast('💾 State saved to clipboard');
                }).catch(err => {
                    console.error('[DRBanger] Failed to save state to clipboard:', err);
                    showErrorToast('Failed to save state to clipboard');
                });
                
            } catch (error) {
                console.error('[DRBanger] Error saving state:', error);
                showErrorToast('Error saving state');
            }
        }

        function loadState() {
            document.getElementById('loadStateModal').classList.remove('hidden');
            document.getElementById('loadStateTextarea').value = '';
        }

        function confirmLoadState() {
            const jsonText = document.getElementById('loadStateTextarea').value.trim();
            
            if (!jsonText) {
                showErrorToast('Please paste state JSON');
                return;
            }
            
            try {
                const state = JSON.parse(jsonText);
                
                // Critical: Validate state structure before restoration
                if (!validateStateStructure(state)) {
                    showErrorToast('Invalid state structure - cannot load');
                    return;
                }
                
                const success = restoreState(state);
                
                if (success) {
                    showStateToast('📁 State loaded successfully');
                    document.getElementById('loadStateModal').classList.add('hidden');
                } else {
                    showErrorToast('Failed to restore state completely');
                }
                
            } catch (error) {
                console.error('[DRBanger] Invalid JSON:', error);
                showErrorToast(`Invalid JSON format: ${error.message}`);
            }
        }

        function validateStateStructure(state) {
            try {
                // Basic structure validation to prevent logic bombs
                if (!state || typeof state !== 'object') {
                    console.error('[DRBanger] State is not an object');
                    return false;
                }
                
                // Check for required fields
                const requiredFields = ['version', 'timestamp'];
                for (const field of requiredFields) {
                    if (!(field in state)) {
                        console.error(`[DRBanger] Missing required field: ${field}`);
                        return false;
                    }
                }
                
                // Validate inputs structure if present
                if (state.inputs && typeof state.inputs !== 'object') {
                    console.error('[DRBanger] Invalid inputs structure');
                    return false;
                }
                
                // Validate botResults structure if present
                if (state.botResults) {
                    if (typeof state.botResults !== 'object') {
                        console.error('[DRBanger] Invalid botResults structure');
                        return false;
                    }
                    
                    // Check for dangerous content in bot results
                    for (const [key, value] of Object.entries(state.botResults)) {
                        if (value && typeof value === 'object' && value.output) {
                            // Basic XSS protection - reject script tags
                            if (typeof value.output === 'string' && value.output.includes('<script')) {
                                console.error('[DRBanger] Potentially dangerous content detected');
                                return false;
                            }
                        }
                    }
                }
                
                console.log('[DRBanger] State structure validation passed');
                return true;
                
            } catch (error) {
                console.error('[DRBanger] State validation error:', error);
                return false;
            }
        }

        function cancelLoadState() {
            document.getElementById('loadStateModal').classList.add('hidden');
        }

        // ===== LIVE LOGGING SYSTEM =====
        
        let loggingSettings = {
            font: 'ui-sans-serif',
            size: 'text-sm'
        };

        let logEntries = [];
        let streamingLogs = {}; // Track streaming responses to accumulate them

        function addLogEntry(type, title, content, timestamp = null) {
            const logTimestamp = timestamp || new Date().toLocaleString();
            const entry = {
                id: Date.now(),
                type,
                title,
                content,
                timestamp: logTimestamp
            };
            
            logEntries.push(entry);
            addLogEntryToDOM(entry);
            updateLogCount();
            console.log(`[DRBanger] Logged ${type}:`, title);
        }

        function addLogEntryToDOM(entry) {
            const loggingContent = document.getElementById('loggingContent');
            const loggingEmpty = document.getElementById('loggingEmpty');
            
            if (loggingEmpty && !loggingEmpty.classList.contains('hidden')) {
                loggingEmpty.classList.add('hidden');
            }
            
            const entryDiv = document.createElement('div');
            entryDiv.className = `log-entry border-l-4 pl-4 py-2 mb-2`;
            entryDiv.style.fontFamily = loggingSettings.font;
            
            // Color coding by type
            let borderColor = 'border-gray-300';
            let bgColor = 'bg-gray-50 dark:bg-gray-800';
            let textColor = 'text-gray-700 dark:text-gray-300';
            
            switch (entry.type) {
                case 'bot_start':
                    borderColor = 'border-blue-500';
                    bgColor = 'bg-blue-50 dark:bg-blue-900/20';
                    textColor = 'text-blue-800 dark:text-blue-200';
                    break;
                case 'bot_input':
                    borderColor = 'border-green-500';
                    bgColor = 'bg-green-50 dark:bg-green-900/20';
                    textColor = 'text-green-800 dark:text-green-200';
                    break;
                case 'bot_output':
                    borderColor = 'border-purple-500';
                    bgColor = 'bg-purple-50 dark:bg-purple-900/20';
                    textColor = 'text-purple-800 dark:text-purple-200';
                    break;
                case 'bot_complete':
                    borderColor = 'border-green-600';
                    bgColor = 'bg-green-100 dark:bg-green-900/30';
                    textColor = 'text-green-900 dark:text-green-100';
                    break;
                case 'bot_error':
                    borderColor = 'border-red-500';
                    bgColor = 'bg-red-50 dark:bg-red-900/20';
                    textColor = 'text-red-800 dark:text-red-200';
                    break;
                case 'manual_complete':
                    borderColor = 'border-yellow-500';
                    bgColor = 'bg-yellow-50 dark:bg-yellow-900/20';
                    textColor = 'text-yellow-800 dark:text-yellow-200';
                    break;
                default:
                    borderColor = 'border-gray-300';
                    bgColor = 'bg-gray-50 dark:bg-gray-800';
                    textColor = 'text-gray-700 dark:text-gray-300';
            }
            
            entryDiv.className += ` ${borderColor} ${bgColor}`;
            
            const isLongContent = entry.content.length > 200;
            const contentPreview = isLongContent ? entry.content.substring(0, 200) + '...' : entry.content;
            const entryId = `log-entry-${entry.id}`;
            
            entryDiv.innerHTML = `
                <div class="flex justify-between items-start mb-1">
                    <div class="flex items-center space-x-2">
                        <span class="font-semibold ${loggingSettings.size} ${textColor}">${entry.title}</span>
                        <span class="text-xs text-gray-500 dark:text-gray-400">${entry.timestamp}</span>
                        ${isLongContent ? `<button onclick="toggleLogExpand('${entryId}')" class="text-xs text-blue-600 dark:text-blue-400 hover:underline">expand</button>` : ''}
                    </div>
                </div>
                <div class="text-sm ${textColor} font-mono whitespace-pre-wrap overflow-x-auto">
                    <div id="${entryId}-preview" class="max-h-32 overflow-y-auto">
                        ${contentPreview}
                    </div>
                    ${isLongContent ? `<div id="${entryId}-full" class="hidden max-h-96 overflow-y-auto">${entry.content}</div>` : ''}
                </div>
            `;
            
            entryDiv.id = entryId;
            loggingContent.appendChild(entryDiv);
            
            // Auto-scroll to bottom
            loggingContent.scrollTop = loggingContent.scrollHeight;
        }

        function updateLogCount() {
            const logCount = document.getElementById('logCount');
            if (logCount) {
                logCount.textContent = `${logEntries.length} activities`;
            }
        }

        function clearAllLogs() {
            logEntries = [];
            const loggingContent = document.getElementById('loggingContent');
            const logItems = loggingContent.querySelectorAll('.log-entry');
            logItems.forEach(item => item.remove());
            
            const loggingEmpty = document.getElementById('loggingEmpty');
            if (loggingEmpty) {
                loggingEmpty.classList.remove('hidden');
            }
            
            updateLogCount();
            showStateToast('🗑️ Activity log cleared');
        }

        function applyLoggingSettings() {
            const content = document.getElementById('loggingContent');
            if (content) {
                content.style.fontFamily = loggingSettings.font;
                // Reapply settings to all existing items
                const logItems = content.querySelectorAll('.log-entry');
                logItems.forEach(item => {
                    item.style.fontFamily = loggingSettings.font;
                });
            }
        }

        // ===== LOADING STATE MANAGEMENT =====
        function setLoadingState(botNumber, isLoading) {
            console.log(`[DRBanger] Setting loading state for Bot ${botNumber}:`, isLoading);
            
            // Button loading state
            const button = document.getElementById(`executeBot${botNumber}`);
            const buttonText = document.getElementById(`executeBot${botNumber}Text`);
            const buttonSpinner = document.getElementById(`executeBot${botNumber}Spinner`);
            
            if (button && buttonText && buttonSpinner) {
                if (isLoading) {
                    buttonText.classList.add('invisible');
                    buttonSpinner.classList.remove('hidden');
                } else {
                    buttonText.classList.remove('invisible');
                    buttonSpinner.classList.add('hidden');
                }
            }
            
            // Panel button loading state for Bot 6
            if (botNumber === 6) {
                const panelButton = document.getElementById('executeBot6Panel');
                const panelText = document.getElementById('executeBot6PanelText');
                const panelSpinner = document.getElementById('executeBot6PanelSpinner');
                
                if (panelButton && panelText && panelSpinner) {
                    if (isLoading) {
                        panelText.classList.add('invisible');
                        panelSpinner.classList.remove('hidden');
                    } else {
                        panelText.classList.remove('invisible');
                        panelSpinner.classList.add('hidden');
                    }
                }
            }
            
            // Workflow progress spinner
            const stepSpinner = document.getElementById(`step${botNumber}Spinner`);
            if (stepSpinner) {
                if (isLoading) {
                    stepSpinner.classList.remove('hidden');
                } else {
                    stepSpinner.classList.add('hidden');
                }
            }
        }

        // ===== CLEAR BUTTON FUNCTIONALITY =====
        function setupClearButtons() {
            for (let i = 1; i <= 6; i++) {
                const clearButton = document.getElementById(`clearBot${i}`);
                const outputDiv = document.getElementById(`bot${i}Output`);
                const statusDiv = document.getElementById(`bot${i}Status`);
                
                if (clearButton && outputDiv) {
                    clearButton.addEventListener('click', () => {
                        console.log(`[DRBanger] Clearing Bot ${i} output`);
                        outputDiv.innerHTML = '';
                        if (statusDiv) {
                            statusDiv.textContent = '';
                        }
                        updateStepStatus(`step${i}Status`, 'idle');
                    });
                }
            }
        }

        // ===== PHASE 2B: MANUAL RECOVERY CONTROLS =====
        function setupResetButtons() {
            for (let i = 1; i <= 6; i++) {
                const resetButton = document.getElementById(`resetBot${i}`);
                
                if (resetButton) {
                    resetButton.addEventListener('click', () => {
                        console.log(`[DRBanger] Manual reset requested for Bot ${i}`);
                        resetBotState(i);
                        showStateToast(`🔄 Bot ${i} state reset manually`);
                        addLogEntry('manual_reset', `Bot ${i} Manual Reset`, 'User manually reset bot state');
                    });
                }
            }
        }

        // ===== PHASE 4: COPY/DOWNLOAD/FEED SYSTEM =====
        
        // Copy functionality
        function showCopyToast() {
            const toast = document.getElementById('copyToast');
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 2000);
        }

        function getFormattedTimestamp() {
            const now = new Date();
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                           'July', 'August', 'September', 'October', 'November', 'December'];
            const month = months[now.getMonth()];
            const date = now.getDate();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            return `${month}${date}_${hours}${minutes}${seconds}`;
        }

        function createMetadata(type, content) {
            const timestamp = new Date().toLocaleString();
            return `---
Type: ${type}
Generated: ${timestamp}
DRBanger System: Phase 5+
---

${content}`;
        }

        function copyToClipboard(content, type) {
            const metadataContent = createMetadata(type, content);
            navigator.clipboard.writeText(metadataContent).then(() => {
                console.log(`[DRBanger] Copied ${type} to clipboard`);
                showCopyToast();
            }).catch(err => {
                console.error('[DRBanger] Copy failed:', err);
                showErrorToast('Copy failed');
            });
        }

        function downloadContent(content, filename, type) {
            const metadataContent = createMetadata(type, content);
            const blob = new Blob([metadataContent], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log(`[DRBanger] Downloaded ${filename}`);
        }

        // Preview system removed - variables kept for compatibility
        let previewItems = [];

        // Setup copy/download/feed buttons for inputs
        function setupInputButtons() {
            // Legal Text buttons
            addManagedEventListener(
                document.getElementById('copyLegalText'),
                'click',
                () => {
                    const content = document.getElementById('legalText').value;
                    if (content.trim()) {
                        copyToClipboard(content, 'Legal Text Input');
                    } else {
                        showErrorToast('No legal text to copy');
                    }
                },
                'Copy Legal Text'
            );

            addManagedEventListener(
                document.getElementById('feedLegalText'),
                'click',
                () => {
                    const content = document.getElementById('legalText').value;
                    if (content.trim()) {
                        addLogEntry('user_input', 'Legal Text Input', content);
                        showStateToast('📤 Legal text logged');
                    } else {
                        showErrorToast('No legal text to feed');
                    }
                },
                'Feed Legal Text'
            );

            // SST Capsule buttons
            addManagedEventListener(
                document.getElementById('copySSTCapsule'),
                'click',
                () => {
                    const content = document.getElementById('sstCapsule').value;
                    if (content.trim()) {
                        copyToClipboard(content, 'SST Technique');
                    } else {
                        showErrorToast('No SST technique to copy');
                    }
                },
                'Copy SST Technique'
            );

            addManagedEventListener(
                document.getElementById('feedSSTCapsule'),
                'click',
                () => {
                    const content = document.getElementById('sstCapsule').value;
                    if (content.trim()) {
                        addLogEntry('user_input', 'SST Technique Input', content);
                        showStateToast('📤 SST technique logged');
                    } else {
                        showErrorToast('No SST technique to feed');
                    }
                },
                'Feed SST Technique'
            );
        }

        // Setup copy/download/feed buttons for bots - Consolidated
        function setupBotButtons() {
            const botNames = ['SST Application', 'Web Adversary', 'International Law SST', 'ICC Insight Extractor', 'Web Verification', 'Dynamic SST Generator'];
            const botActions = {
                copy: (i, content) => content.trim() ? copyToClipboard(content, `Bot ${i}: ${botNames[i-1]}`) : showErrorToast(`No Bot ${i} output to copy`),
                download: (i, content) => {
                    if (content.trim()) {
                        const timestamp = getFormattedTimestamp();
                        const filename = `Bot${i}_${timestamp}.md`;
                        downloadContent(content, filename, `Bot ${i}: ${botNames[i-1]}`);
                    } else {
                        showErrorToast(`No Bot ${i} output to download`);
                    }
                },
                feed: (i, content) => content.trim() ? (addLogEntry('user_feed', `Bot ${i} Output`, content), showStateToast(`📤 Bot ${i} output logged`)) : showErrorToast(`No Bot ${i} output to feed`)
            };
            
            for (let i = 1; i <= 6; i++) {
                ['copy', 'download', 'feed'].forEach(action => {
                    document.getElementById(`${action}Bot${i}`).addEventListener('click', () => {
                        const content = document.getElementById(`bot${i}Output`).textContent;
                        botActions[action](i, content);
                    });
                });
            }
        }

        // Download Flow functionality
        function downloadFlow() {
            const timestamp = getFormattedTimestamp();
            const filename = `DRBanger_Flow_${timestamp}.md`;
            
            let flowContent = '# DRBanger Enhanced Legal Research System - Complete Flow\n\n';
            
            // Add inputs
            const legalText = document.getElementById('legalText').value.trim();
            const sstTechnique = document.getElementById('sstCapsule').value.trim();
            
            if (legalText) {
                flowContent += '## Legal Text Input\n\n' + legalText + '\n\n';
            }
            
            if (sstTechnique) {
                flowContent += '## SST Technique\n\n' + sstTechnique + '\n\n';
            }
            
            // Add bot outputs
            const botNames = ['SST Mechanical Application', 'Web Adversary', 'International Law SST Validation', 'ICC Insight Extraction', 'Web Verification', 'Dynamic SST Generation'];
            
            for (let i = 1; i <= 6; i++) {
                const content = document.getElementById(`bot${i}Output`).textContent.trim();
                if (content) {
                    flowContent += `## Bot ${i}: ${botNames[i-1]}\n\n${content}\n\n`;
                }
            }
            
            if (flowContent === '# DRBanger Enhanced Legal Research System - Complete Flow\n\n') {
                showErrorToast('No content available to download');
                return;
            }
            
            downloadContent(flowContent, filename, 'Complete DRBanger Flow');
        }

        // ===== SST DATABASE SYSTEM =====
        let sstDatabase = null;

        // SST Database file upload handler - PROTECTED JSON PARSING
        document.getElementById('sstDatabaseFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/json') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = safeJsonParse(e.target.result, 'SST Database');
                        if (!data) return;
                        
                        // Validate SST database structure
                        if (!Array.isArray(data)) {
                            showErrorToast('SST Database must be an array');
                            return;
                        }
                        
                        // Basic structure validation
                        for (const domain of data) {
                            if (!domain || typeof domain !== 'object' || !domain.domain || !Array.isArray(domain.techniques)) {
                                showErrorToast('Invalid SST Database structure - each domain must have "domain" and "techniques" array');
                                return;
                            }
                        }
                        
                        sstDatabase = data;
                        document.getElementById('sstDatabaseStatus').textContent = `Loaded ${countTechniques(data)} techniques from ${data.length} domains`;
                        document.getElementById('sstDatabaseStatus').className = 'text-sm text-green-600 dark:text-green-400';
                        initializeCascadingDropdowns();
                        console.log('[DRBanger] SST Database loaded successfully:', data);
                    } catch (error) {
                        console.error('[DRBanger] Failed to load SST database:', error);
                        showErrorToast(`SST Database error: ${error.message}`);
                        document.getElementById('sstDatabaseStatus').textContent = 'Failed to load database';
                        document.getElementById('sstDatabaseStatus').className = 'text-sm text-red-600 dark:text-red-400';
                    }
                };
                reader.readAsText(file);
            }
        });

        function countTechniques(database) {
            return database.reduce((total, domain) => total + domain.techniques.length, 0);
        }

        // Random SST sampling
        function getRandomSST() {
            if (!sstDatabase || !Array.isArray(sstDatabase)) return null;
            
            const allTechniques = [];
            sstDatabase.forEach(domain => {
                domain.techniques.forEach(tech => {
                    allTechniques.push({
                        ...tech,
                        domain: domain.domain
                    });
                });
            });

            if (allTechniques.length === 0) return null;
            
            const randomTech = allTechniques[Math.floor(Math.random() * allTechniques.length)];
            return `**SST TECHNIQUE**: ${randomTech.name} (${randomTech.domain})\n**APPLICATION METHOD**: ${randomTech.method}`;
        }

        // ===== BOT PROMPT TEMPLATES =====
        const botPrompts = {
            bot1: (legalText, sstTechnique, customInstruction) => {
                return `ROLE: sst_mechanical_applicator
TASK: Apply the provided SST technique mechanically to legal text

CUSTOM_INSTRUCTION_OVERRIDE: ${customInstruction || '[NULL - Using standard protocol]'}

LEGAL TEXT: ${legalText}
SST TECHNIQUE: ${sstTechnique}

INSTRUCTIONS:
1. Apply the SST technique MECHANICALLY to the legal text structure
2. Do NOT interpret legal meaning - treat text as raw material for transformation
3. Transform the legal text THROUGH the SST lens as if it were data/code/music/etc
4. Show exactly HOW the transformation changes the text's structure
5. Include confidence score (0-100) for the mechanical application

OUTPUT FORMAT: 
[SST Applied: <technique name>]
[Confidence: XX/100]

<Mechanical transformation of the legal text through the SST lens>`;
            },

            bot2: (bot1Output, legalText, customInstruction) => {
                return `ROLE: web_research_critic
TASK: Conduct research-backed demolition of SST application as methodologically invalid

CUSTOM_INSTRUCTION_OVERRIDE: ${customInstruction || '[NULL - Using standard protocol]'}

BOT 1 OUTPUT: ${bot1Output}
ORIGINAL ICC TEXT: ${legalText}

MANDATE: You are the research-armed skeptic. Use web search to find evidence that demolishes this SST transformation. Your job is to show why this approach is fundamentally flawed using current legal scholarship and established interpretive methods. Research and demonstrate why this SST technique violates established legal interpretation principles. Find evidence of methodological standards, precedential requirements, and scholarly consensus that contradicts this approach. Show how courts actually interpret legal text versus this transformation method. Document the practical impossibility of implementing such interpretive techniques in real legal proceedings. Your criticism should be devastating but research-backed - use web search to find the ammunition, then deploy it systematically to dismantle the SST application.

TONE: Relentless but scholarly. Think devastating law review takedown with citations.`;
            },

            bot3: (bot2Output, bot1Output, customInstruction) => {
                return `ROLE: sst_proof_architect
ASSUMED POSITION: This SST transformation reveals genuine structural insights in legal text
TASK: Provide step-by-step reasoning proof of why this specific transformation works

CUSTOM_INSTRUCTION_OVERRIDE: ${customInstruction || '[NULL - Using standard protocol]'}

CONTEXT: Bot 2 has raised methodological concerns. Your job is to demonstrate the logical foundation for why this particular SST application should be valid, using pure analytical reasoning.

CHAIN-OF-THOUGHT MANDATE:
Break down your reasoning into clear, logical steps. Start from first principles and build your case systematically. Think like a patient teacher explaining a complex concept to an intelligent student.

REASONING FRAMEWORK:
1. **Structural Analysis**: What specific textual patterns does this SST technique reveal?
2. **Logical Foundation**: Why should these patterns matter for legal interpretation?
3. **Mechanistic Explanation**: How exactly does the transformation process uncover hidden meaning?
4. **Conceptual Bridge**: What makes this different from random textual manipulation?
5. **Validation Logic**: What internal checks confirm the transformation is meaningful?

OUTPUT STRUCTURE:
**STEP-BY-STEP REASONING**: [Clear logical progression explaining why this works]
**STRUCTURAL INSIGHTS REVEALED**: [Specific textual patterns the SST exposes]
**INTERPRETIVE VALUE**: [Why these revelations matter for legal understanding]
**METHODOLOGICAL SOUNDNESS**: [Internal logic that validates the approach]
**RESPONSE TO SKEPTICISM**: [Calm, reasoned response to Bot 2's concerns]

APPROACH: Patient, analytical, assuming good faith from all parties. Focus on logical demonstration rather than defensive argumentation.`;
            },

            bot4: (bot2Output, bot3Output, legalText, sstTechnique, customInstruction) => {
                return `ROLE: legal_research_developer
TASK: Develop Bot 3's reasoning into research article format with web-based evidence

CUSTOM_INSTRUCTION_OVERRIDE: ${customInstruction || '[NULL - Using standard protocol]'}

INPUTS: 
Bot 3 Output: ${bot3Output}
Original ICC Text: ${legalText}
SST Applied: ${sstTechnique}

MANDATE: Take the specific SST methodology that Bot 1 applied mechanically and Bot 3 reasoned through, and develop this particular approach into a comprehensive research analysis using web search for current legal evidence. Focus on this exact SST technique and how it reveals structural insights in the specific legal text provided. Build the case for why this particular transformation works by researching current ICC jurisprudence and legal interpretation scholarship that supports the reasoning. After establishing the central argument with research evidence, demonstrate how this same SST methodology could apply to other ICC articles for illustrative purposes, showing the broader applicability of the approach. Structure your analysis like a legal research article that takes a specific interpretive technique, proves its validity through evidence and reasoning, then shows its potential applications. Use web search to find supporting precedents, scholarly discussions of interpretive methodology, and current legal developments that validate this approach.`;
            },

            bot5: (bot4Output, customInstruction) => {
                return `ROLE: legal_research_evaluation_specialist
SYSTEM_CONTEXT: You are Bot 5 in a 6-bot legal analysis workflow. Your sole mandate is evaluating Bot 4's output against publication-quality standards for ICC legal scholarship.

WORKFLOW_POSITION: You receive Bot 4's finalized legal research output. You do NOT evaluate SST methodology or transformation processes - that is handled elsewhere in the system.

CUSTOM_INSTRUCTION_OVERRIDE: ${customInstruction || '[NULL - Using standard protocol]'}

EVALUATION_TARGET: Bot 4 Output Assessment
"""
${bot4Output}
"""

EVALUATION_MANDATE: 
You are the constructive realist in this system - a subject matter expert guide who provides honest, objective assessment without agenda. Your role is analogous to an expert supervisor reviewing research for publication readiness.

ASSESSMENT_FRAMEWORK:
Evaluate Bot 4's output against these integrated criteria:

1. **Legal Research Validity**: Does this represent sound legal analysis grounded in established ICC jurisprudence and international criminal law principles?
2. **Research Gap Identification**: Does this analysis fill a genuine gap in current ICC legal scholarship, or does it retread well-covered ground?
3. **Abstraction Level Assessment**: Has the analysis maintained sufficient specificity for practical legal application, or has it abstracted beyond useful legal discourse?
4. **Publication Quality Standards**: Would this research output meet the standards for citation in academic legal journals focusing on international criminal law?
5. **Precedential Integration**: Does the analysis properly engage with existing ICC case law and demonstrate awareness of current jurisprudential developments?

WEB_VERIFICATION_PROTOCOL:
Conduct targeted searches to verify:
- Current state of ICC legal scholarship on the analyzed topic
- Recent precedential developments that might affect the analysis
- Existing academic work that might overlap with or contradict the findings
- Gap analysis: what specific contribution this research makes to the field

SCORING_METHODOLOGY:
Generate a single comprehensive score (0-100) that represents overall publication-readiness assessment:
- 90-100: Exceptional contribution, ready for top-tier academic publication
- 80-89: Strong research with minor refinements needed
- 70-79: Solid foundation but requires significant development
- 60-69: Conceptually sound but needs substantial revision
- Below 60: Fundamental issues requiring major reconceptualization

OUTPUT_STRUCTURE:
**EVALUATION_SCORE**: [XX/100]

**RESEARCH_VALIDITY_ASSESSMENT**: [Detailed analysis of legal soundness and jurisprudential grounding]

**GAP_ANALYSIS**: [Specific identification of what unique contribution this makes to ICC scholarship]

**ABSTRACTION_REVIEW**: [Assessment of specificity vs. generalization balance]

**PUBLICATION_READINESS**: [Direct assessment of citation-worthiness and academic contribution potential]

**DEVELOPMENT_RECOMMENDATIONS**: [Constructive guidance for improvement, if needed]

**VERIFICATION_SUMMARY**: [Key findings from web search regarding existing scholarship and precedent]

CRITICAL_CONSTRAINTS:
- Maintain absolute objectivity - you are evaluating research quality, not advocating for any position
- Focus exclusively on the research output itself, not the methodology used to generate it
- Provide constructive, actionable feedback that enables iteration improvement
- Ground all assessments in verifiable legal standards and academic publication criteria`;
            },

            bot6: (conversationHistory, customDomain, customInstruction, userInstruction) => {
                return `ROLE: advanced_sst_synthesis_architect
SYSTEM_CONTEXT: You are Bot 6, the most sophisticated component in a 6-bot legal research enhancement system. You possess complete understanding of the workflow and serve as the iteration improvement engine.

SST_METHODOLOGY_FOUNDATION:
Sentence Transformation Techniques (SSTs) are cross-domain analytical frameworks that apply transformation principles from non-legal fields to legal interpretation.

CURRENT_WORKFLOW_CONTEXT:
Complete conversation history and bot outputs:
"""
${conversationHistory}
"""

CUSTOM_INSTRUCTION_OVERRIDE: ${userInstruction || '[NULL - Using standard protocol]'}

DOMAIN_SPECIFICATION:
Custom Domain: ${customDomain || '[NULL - Select optimal domain based on analysis gaps]'}

CUSTOM_INSTRUCTION_OVERRIDE:
User Guidance: ${customInstruction || '[NULL - Use standard generation protocol]'}

GENERATION_MANDATE:
Your goal is NOT to produce direct legal answers but to generate an SST that will improve the next workflow iteration. The SST should address weaknesses identified in Bot 5's evaluation while leveraging insights from the complete workflow history.

CRITICAL_OUTPUT_CONSTRAINT:
Your response must ONLY contain the SST in the standard format below. Do NOT include reasoning, explanations, or additional text.

REQUIRED_OUTPUT_FORMAT:
**SST TECHNIQUE**: [Domain-specific technique name]
**APPLICATION METHOD**: [Precise mechanical transformation approach]

GENERATION_PROTOCOL:
1. Analyze the complete conversation flow internally
2. Identify gaps and weaknesses from Bot 5's evaluation
3. Select optimal domain (custom domain if provided, otherwise based on gap analysis)
4. Design SST to address specific weaknesses identified
5. Output ONLY the SST in the required format above`;
            }
        };

        // ===== PHASE 2A: BOT EXECUTION TIMEOUT SYSTEM =====
        
        function resetBotState(botNumber) {
            console.log(`[DRBanger] Resetting Bot ${botNumber} state`);
            
            // Clear bot from active executions
            activeBotExecutions.delete(botNumber);
            
            // Clear timeout if exists
            if (botExecutionTimeouts.has(botNumber)) {
                clearTimeout(botExecutionTimeouts.get(botNumber));
                botExecutionTimeouts.delete(botNumber);
                console.log(`[DRBanger] Cleared timeout for Bot ${botNumber}`);
            }
            
            // Reset UI state
            const stepMap = { 1: 'step1Status', 2: 'step2Status', 3: 'step3Status', 4: 'step4Status', 5: 'step5Status', 6: 'step6Status' };
            updateStepStatus(stepMap[botNumber], 'idle');
            
            // Reset status display
            const statusElement = document.getElementById(`bot${botNumber}Status`);
            if (statusElement) {
                statusElement.textContent = "";
                statusElement.className = 'text-sm text-gray-600 dark:text-gray-400 mb-2';
            }
            
            // Update all button states
            updateAllButtonStates();
            updateFloatingButton();
            
            console.log(`[DRBanger] Bot ${botNumber} state reset complete`);
        }

        // ===== UTILITY FUNCTIONS =====
        
        function updateStepStatus(stepId, status) {
            const element = document.getElementById(stepId);
            if (!element) return;

            element.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'bg-blue-500', 'bg-green-500', 'bg-red-500');
            element.classList.remove('text-gray-700', 'dark:text-gray-300', 'text-white');

            switch (status) {
                case 'active':
                    element.classList.add('bg-blue-500', 'text-white');
                    break;
                case 'complete':
                    element.classList.add('bg-green-500', 'text-white');
                    break;
                case 'error':
                    element.classList.add('bg-red-500', 'text-white');
                    break;
                default:
                    element.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            }
        }

        function handleBotResponse(result, botNum, onComplete) {
            const status = document.getElementById(`${botNum}Status`);
            const output = document.getElementById(`${botNum}Output`);
            
            // Update model display in results section
            updateBotModelDisplay(botNum);
            
            if (result.responses && result.responses.length > 0) {
                const response = result.responses[0];
                
                if (response.status === "error") {
                    console.error(`[DRBanger] Bot ${botNum} error:`, response.statusText);
                    status.textContent = "❌ Error occurred";
                    status.className = 'text-sm text-red-600 dark:text-red-400 mb-2';
                    output.innerHTML = `<div class="text-red-600">Error: ${response.statusText || 'Unknown error'}</div>`;
                    onBotEnd(botNum.replace('bot', ''));
                    updateStepStatus(`step${botNum.replace('bot', '')}Status`, 'error');
                    
                    // Log bot error (not accumulated)
                    addLogEntry('bot_error', `${botNum} Error`, response.statusText || 'Unknown error');
                } else if (response.status === "incomplete") {
                    status.textContent = "⏳ Generating response...";
                    status.className = 'text-sm text-blue-600 dark:text-blue-400 mb-2';
                    output.innerHTML = marked.parse(response.content || "Loading...");
                    
                    // Accumulate streaming logs instead of creating new entries each time
                    updateStreamingLog(botNum, response.content);
                } else if (response.status === "complete") {
                    console.log(`[DRBanger] Bot ${botNum} completed successfully`);
                    status.textContent = "✅ Complete";
                    status.className = 'text-sm text-green-600 dark:text-green-400 mb-2';
                    output.innerHTML = marked.parse(response.content);
                    onBotEnd(botNum.replace('bot', ''));
                    
                    // Finalize streaming log
                    finalizeStreamingLog(botNum, response.content);
                    
                    if (onComplete && typeof onComplete === 'function') {
                        onComplete();
                    }
                }
            } else {
                console.error(`[DRBanger] ${botNum}: No response received`);
                onBotEnd(botNum.replace('bot', ''));
                showErrorToast(`${botNum}: No response received`);
                addLogEntry('bot_error', `${botNum} Error`, 'No response received');
            }
        }

        // New function to update model display in results section
        function updateBotModelDisplay(botNum) {
            const botNumber = parseInt(botNum.replace('bot', ''));
            const modelDisplayElement = document.getElementById(`${botNum}ModelDisplay`);
            
            if (modelDisplayElement) {
                const selectedModel = selectedBotModels[botNumber - 1];
                if (selectedModel) {
                    modelDisplayElement.textContent = selectedModel;
                    modelDisplayElement.className = 'text-xs font-mono bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-2 py-1 rounded';
                } else {
                    modelDisplayElement.textContent = 'No model selected';
                    modelDisplayElement.className = 'text-xs font-mono bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 px-2 py-1 rounded';
                }
            }
        }

        // Streaming log accumulation functions
        function updateStreamingLog(botNum, content) {
            if (!content || content.length < 50) return; // Avoid spam for very short content
            
            const logKey = `${botNum}_streaming`;
            
            if (!streamingLogs[logKey]) {
                // Create new streaming log entry
                const entry = {
                    id: Date.now(),
                    type: 'bot_output',
                    title: `${botNum} Streaming`,
                    content: content,
                    timestamp: new Date().toLocaleString(),
                    isStreaming: true
                };
                
                streamingLogs[logKey] = entry;
                logEntries.push(entry);
                addStreamingLogToDOM(entry);
                updateLogCount();
            } else {
                // Update existing streaming log
                streamingLogs[logKey].content = content;
                updateStreamingLogInDOM(logKey, content);
            }
        }

        function finalizeStreamingLog(botNum, finalContent) {
            const logKey = `${botNum}_streaming`;
            
            if (streamingLogs[logKey]) {
                // Update to final content and mark as complete
                streamingLogs[logKey].content = finalContent;
                streamingLogs[logKey].title = `${botNum} Complete`;
                streamingLogs[logKey].type = 'bot_complete';
                streamingLogs[logKey].isStreaming = false;
                
                // Update DOM
                updateStreamingLogInDOM(logKey, finalContent, true);
                
                // Clean up
                delete streamingLogs[logKey];
            } else {
                // No streaming log exists, create completion log
                addLogEntry('bot_complete', `${botNum} Complete`, `Final output: ${finalContent.substring(0, 300)}${finalContent.length > 300 ? '...' : ''}`);
            }
        }

        function addStreamingLogToDOM(entry) {
            const loggingContent = document.getElementById('loggingContent');
            const loggingEmpty = document.getElementById('loggingEmpty');
            
            if (loggingEmpty && !loggingEmpty.classList.contains('hidden')) {
                loggingEmpty.classList.add('hidden');
            }
            
            const entryDiv = document.createElement('div');
            entryDiv.className = `log-entry streaming border-l-4 pl-4 py-2 mb-2 border-purple-500 bg-purple-50 dark:bg-purple-900/20`;
            entryDiv.style.fontFamily = loggingSettings.font;
            entryDiv.id = `log-${entry.id}`;
            
            const isLongContent = entry.content.length > 200;
            const contentPreview = isLongContent ? entry.content.substring(0, 200) + '...' : entry.content;
            
            entryDiv.innerHTML = `
                <div class="flex justify-between items-start mb-1">
                    <div class="flex items-center space-x-2">
                        <span class="font-semibold ${loggingSettings.size} text-purple-800 dark:text-purple-200">${entry.title} ⚡</span>
                        <span class="text-xs text-gray-500 dark:text-gray-400">${entry.timestamp}</span>
                        ${isLongContent ? `<button onclick="toggleLogExpand('log-${entry.id}')" class="text-xs text-blue-600 dark:text-blue-400 hover:underline">expand</button>` : ''}
                    </div>
                </div>
                <div class="text-sm text-purple-800 dark:text-purple-200 font-mono whitespace-pre-wrap overflow-x-auto">
                    <div id="log-${entry.id}-preview" class="max-h-32 overflow-y-auto">
                        ${contentPreview}
                    </div>
                    ${isLongContent ? `<div id="log-${entry.id}-full" class="hidden max-h-96 overflow-y-auto">${entry.content}</div>` : ''}
                </div>
            `;
            
            loggingContent.appendChild(entryDiv);
            loggingContent.scrollTop = loggingContent.scrollHeight;
        }

        function updateStreamingLogInDOM(logKey, content, isComplete = false) {
            const entry = streamingLogs[logKey];
            if (!entry) return;
            
            const entryDiv = document.getElementById(`log-${entry.id}`);
            if (!entryDiv) return;
            
            const isLongContent = content.length > 200;
            const contentPreview = isLongContent ? content.substring(0, 200) + '...' : content;
            
            // Update title if complete
            const titleSpan = entryDiv.querySelector('.font-semibold');
            if (isComplete && titleSpan) {
                titleSpan.textContent = `${entry.title.split(' ')[0]} Complete ✅`;
                entryDiv.className = entryDiv.className.replace('border-purple-500 bg-purple-50 dark:bg-purple-900/20', 'border-green-600 bg-green-100 dark:bg-green-900/30');
                titleSpan.className = titleSpan.className.replace('text-purple-800 dark:text-purple-200', 'text-green-900 dark:text-green-100');
            }
            
            // Update content
            const previewDiv = entryDiv.querySelector(`#log-${entry.id}-preview`);
            const fullDiv = entryDiv.querySelector(`#log-${entry.id}-full`);
            
            if (previewDiv) {
                previewDiv.textContent = contentPreview;
            }
            if (fullDiv) {
                fullDiv.textContent = content;
            }
            
            // Auto-scroll to bottom
            const loggingContent = document.getElementById('loggingContent');
            loggingContent.scrollTop = loggingContent.scrollHeight;
        }

        // ===== CASCADING DROPDOWN SYSTEM =====
        function initializeCascadingDropdowns() {
            if (!sstDatabase || !Array.isArray(sstDatabase)) return;
            
            const domainSelect = document.getElementById('sstDomainSelect');
            const techniqueSelect = document.getElementById('sstTechniqueSelect');

            // Populate domain dropdown
            domainSelect.innerHTML = '<option value="">Select a domain...</option>';
            sstDatabase.forEach(domain => {
                const option = document.createElement('option');
                option.value = domain.domain;
                option.textContent = domain.domain;
                domainSelect.appendChild(option);
            });

            // Domain selection handler
            domainSelect.addEventListener('change', function() {
                const selectedDomain = this.value;
                techniqueSelect.innerHTML = '<option value="">Select a technique...</option>';
                techniqueSelect.disabled = !selectedDomain;

                if (selectedDomain) {
                    const domainData = sstDatabase.find(d => d.domain === selectedDomain);
                    if (domainData) {
                        domainData.techniques.forEach(tech => {
                            const option = document.createElement('option');
                            option.value = JSON.stringify({ name: tech.name, method: tech.method });
                            option.textContent = tech.name;
                            techniqueSelect.appendChild(option);
                        });
                        techniqueSelect.disabled = false;
                    }
                }
            });

            // Technique selection handler - auto-apply to SST box
            techniqueSelect.addEventListener('change', function() {
                if (this.value) {
                    try {
                        const { name, method } = JSON.parse(this.value);
                        const formattedSST = `**SST TECHNIQUE**: ${name}\n**APPLICATION METHOD**: ${method}`;
                        document.getElementById('sstCapsule').value = formattedSST;
                        console.log('[DRBanger] SST auto-applied:', formattedSST);
                        
                        // Reset dropdowns
                        domainSelect.value = '';
                        techniqueSelect.innerHTML = '<option value="">Select a technique...</option>';
                        techniqueSelect.disabled = true;
                    } catch (error) {
                        console.error('[DRBanger] Error applying selected SST:', error);
                        showErrorToast('Error applying selected SST');
                    }
                }
            });
        }

        // ===== SIMPLIFIED BOT EXECUTION TRACKING =====
        
        let currentWorkflowBot = 1;
        let workflowRunning = false;
        let activeBotExecutions = new Set(); // Track currently running bots for UI feedback only
        let botExecutionTimeouts = new Map(); // Track timeout IDs for bot executions

        function updateFloatingButton() {
            const button = document.getElementById('nextBotButton');
            const text = document.getElementById('nextBotText');
            const spinner = document.getElementById('nextBotSpinner');
            
            // Only disable floating button if it's specifically running
            const floatingBotRunning = activeBotExecutions.has(currentWorkflowBot);
            
            if (floatingBotRunning) {
                text.classList.add('hidden');
                spinner.classList.remove('hidden');
                button.disabled = true;
                button.classList.add('opacity-50', 'cursor-not-allowed');
                text.textContent = `⏳ Running Bot ${currentWorkflowBot}...`;
            } else {
                text.classList.remove('hidden');
                spinner.classList.add('hidden');
                button.disabled = false;
                button.classList.remove('opacity-50', 'cursor-not-allowed');
                
                if (currentWorkflowBot <= 6) {
                    text.textContent = `▶️ Next: Bot ${currentWorkflowBot}`;
                } else {
                    text.textContent = `🔄 Restart: Bot 1`;
                    currentWorkflowBot = 1;
                }
            }
        }

        function advanceWorkflow() {
            // Allow workflow to proceed even if other bots are running
            console.log(`[DRBanger] Floating button executing Bot ${currentWorkflowBot}`);
            executeBot(currentWorkflowBot);
        }

        function onBotComplete(botNumber) {
            console.log(`[DRBanger] Bot ${botNumber} completed, syncing workflow`);
            
            // If this was the workflow bot, advance the sequence
            if (botNumber === currentWorkflowBot) {
                if (currentWorkflowBot === 6) {
                    currentWorkflowBot = 1;
                    showStateToast('🎉 Workflow complete! Ready to restart.');
                } else {
                    currentWorkflowBot++;
                }
            }
            
            updateFloatingButton();
            updateAllButtonStates(); // Sync all buttons
        }

        function onBotStart(botNumber) {
            console.log(`[DRBanger] Bot ${botNumber} started, tracking for UI`);
            activeBotExecutions.add(botNumber);
            
            updateFloatingButton();
            updateAllButtonStates();
        }

        function onBotEnd(botNumber) {
            console.log(`[DRBanger] Bot ${botNumber} ended, updating UI`);
            activeBotExecutions.delete(botNumber);
            
            // PHASE 2A: Clear timeout when bot ends
            if (botExecutionTimeouts.has(botNumber)) {
                clearTimeout(botExecutionTimeouts.get(botNumber));
                botExecutionTimeouts.delete(botNumber);
                console.log(`[DRBanger] Cleared timeout for Bot ${botNumber} on normal completion`);
            }
            
            updateFloatingButton();
            updateAllButtonStates();
        }

        // ===== SIMPLIFIED BUTTON STATE MANAGEMENT =====
        function updateAllButtonStates() {
            for (let i = 1; i <= 6; i++) {
                const isRunning = activeBotExecutions.has(i);
                
                // Update input tab buttons - show loading state but DON'T disable multiple executions
                const inputButton = document.getElementById(`executeBot${i}`);
                const inputText = document.getElementById(`executeBot${i}Text`);
                const inputSpinner = document.getElementById(`executeBot${i}Spinner`);
                
                if (inputButton) {
                    // Always keep buttons enabled for multiple executions
                    inputButton.disabled = false;
                    inputButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    
                    if (isRunning) {
                        if (inputText) inputText.classList.add('invisible');
                        if (inputSpinner) inputSpinner.classList.remove('hidden');
                    } else {
                        if (inputText) inputText.classList.remove('invisible');
                        if (inputSpinner) inputSpinner.classList.add('hidden');
                    }
                }
                
                // Update results tab buttons - same logic
                const resultsButton = document.getElementById(`executeBot${i}Results`);
                if (resultsButton) {
                    resultsButton.disabled = false;
                    resultsButton.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                
                // Update Bot 6 panel button
                if (i === 6) {
                    const panelButton = document.getElementById('executeBot6Panel');
                    const panelText = document.getElementById('executeBot6PanelText');
                    const panelSpinner = document.getElementById('executeBot6PanelSpinner');
                    
                    if (panelButton) {
                        panelButton.disabled = false;
                        panelButton.classList.remove('opacity-50', 'cursor-not-allowed');
                        
                        if (isRunning) {
                            if (panelText) panelText.classList.add('invisible');
                            if (panelSpinner) panelSpinner.classList.remove('hidden');
                        } else {
                            if (panelText) panelText.classList.remove('invisible');
                            if (panelSpinner) panelSpinner.classList.add('hidden');
                        }
                    }
                }
            }
        }

        // ===== POE HANDLERS =====
        
        ['bot1', 'bot2', 'bot3', 'bot4', 'bot5', 'bot6'].forEach(botId => {
            window.Poe.registerHandler(`${botId}-handler`, (result) => {
                const stepMap = { bot1: 'step1Status', bot2: 'step2Status', bot3: 'step3Status', bot4: 'step4Status', bot5: 'step5Status', bot6: 'step6Status' };
                
                handleBotResponse(result, botId, () => {
                    updateStepStatus(stepMap[botId], 'complete');
                    
                    // Special handling for Bot 6 - extract SST and put in main box
                    if (botId === 'bot6' && result.responses && result.responses.length > 0) {
                        const content = result.responses[0].content;
                        const sstMatch = content.match(/\*\*SST TECHNIQUE\*\*:\s*(.*?)\n\*\*APPLICATION METHOD\*\*:\s*(.*?)(?:\n|$)/s);
                        if (sstMatch) {
                            const formattedSST = `**SST TECHNIQUE**: ${sstMatch[1].trim()}\n**APPLICATION METHOD**: ${sstMatch[2].trim()}`;
                            document.getElementById('sstCapsule').value = formattedSST;
                            console.log('[DRBanger] Bot 6 auto-fed SST to main box:', formattedSST);
                        }
                    }
                    
                    // Advance floating button workflow
                    const botNumber = parseInt(botId.replace('bot', ''));
                    onBotComplete(botNumber);
                });
            });
        });

        // ===== BOT EXECUTION FUNCTIONS =====
        
        async function executeBot(botNumber) {
            console.log(`[DRBanger] Executing Bot ${botNumber}`);
            
            const legalText = document.getElementById('legalText').value.trim();
            const sstTechnique = document.getElementById('sstCapsule').value.trim();
            
            const botSelector = botSelectors.find(s => s.botId === `bot${botNumber}`);
            const botName = botSelector ? botSelector.selectedModel : selectedBotModels[botNumber - 1];
            
            // NEW: Get the injected instruction for the current bot
            const customInstruction = injectedInstructions[botNumber];

            addLogEntry('bot_start', `Bot ${botNumber} Started`, `Executing ${botName || 'No model'} with ${legalText ? 'legal text' : 'no legal text'} and ${sstTechnique ? 'SST technique' : 'no SST'}`);
            
            const cleanBotName = botName ? botName.replace(/^@/, '') : '';
            
            if (!cleanBotName) {
                showErrorToast(`Bot ${botNumber}: No model selected`);
                onBotEnd(botNumber); // Use onBotEnd to sync UI
                addLogEntry('bot_error', `Bot ${botNumber} Error`, 'No model selected');
                return;
            }
            
            const stepMap = { 1: 'step1Status', 2: 'step2Status', 3: 'step3Status', 4: 'step4Status', 5: 'step5Status', 6: 'step6Status' };
            
            let prompt;
            
            onBotStart(botNumber); // Use onBotStart to sync UI
            updateStepStatus(stepMap[botNumber], 'active');
            document.getElementById(`bot${botNumber}Status`).textContent = "🚀 Starting analysis...";
            
            // PHASE 2A: Set timeout for bot execution (180 seconds)
            const timeoutId = setTimeout(() => {
                console.warn(`[DRBanger] Bot ${botNumber} timed out after 180 seconds`);
                showErrorToast(`Bot ${botNumber} timed out - resetting state`);
                resetBotState(botNumber);
                addLogEntry('bot_error', `Bot ${botNumber} Timeout`, 'Execution timed out after 3 minutes');
            }, 180000); // 180 seconds = 3 minutes
            
            botExecutionTimeouts.set(botNumber, timeoutId);
            console.log(`[DRBanger] Set timeout for Bot ${botNumber}:`, timeoutId);
            
            try {
                switch (botNumber) {
                    case 1:
                        if (!legalText || !sstTechnique) {
                            showErrorToast("Bot 1: Missing legal text or SST technique - proceeding anyway");
                            console.warn('[DRBanger] Bot 1 missing inputs but proceeding');
                        }
                        if (customPrompts.bot1) {
                            prompt = customPrompts.bot1
                                .replace(/\${legalText}/g, legalText || "[NO LEGAL TEXT PROVIDED]")
                                .replace(/\${sstTechnique}/g, sstTechnique || "[NO SST TECHNIQUE PROVIDED]");
                        } else {
                            prompt = botPrompts.bot1(legalText || "[NO LEGAL TEXT PROVIDED]", sstTechnique || "[NO SST TECHNIQUE PROVIDED]", customInstruction);
                        }
                        break;
                        
                    case 2:
                        const bot1Output = document.getElementById('bot1Output').textContent;
                        if (!bot1Output) {
                            showErrorToast("Bot 2: No Bot 1 output available - proceeding anyway");
                            console.warn('[DRBanger] Bot 2 missing Bot 1 output but proceeding');
                        }
                        if (customPrompts.bot2) {
                            prompt = customPrompts.bot2
                                .replace(/\${bot1Output}/g, bot1Output || "[NO BOT 1 OUTPUT]")
                                .replace(/\${legalText}/g, legalText || "[NO LEGAL TEXT]");
                        } else {
                            prompt = botPrompts.bot2(bot1Output || "[NO BOT 1 OUTPUT]", legalText || "[NO LEGAL TEXT]", customInstruction);
                        }
                        break;
                        
                    case 3:
                        const bot2Output = document.getElementById('bot2Output').textContent;
                        const bot1Output3 = document.getElementById('bot1Output').textContent;
                        if (!bot2Output || !bot1Output3) {
                            showErrorToast("Bot 3: Missing previous bot outputs - proceeding anyway");
                            console.warn('[DRBanger] Bot 3 missing previous outputs but proceeding');
                        }
                        if (customPrompts.bot3) {
                            prompt = customPrompts.bot3
                                .replace(/\${bot2Output}/g, bot2Output || "[NO BOT 2 OUTPUT]")
                                .replace(/\${bot1Output}/g, bot1Output3 || "[NO BOT 1 OUTPUT]");
                        } else {
                            prompt = botPrompts.bot3(bot2Output || "[NO BOT 2 OUTPUT]", bot1Output3 || "[NO BOT 1 OUTPUT]", customInstruction);
                        }
                        break;
                        
                    case 4:
                        const bot2Output4 = document.getElementById('bot2Output').textContent;
                        const bot3Output = document.getElementById('bot3Output').textContent;
                        if (!bot2Output4 || !bot3Output) {
                            showErrorToast("Bot 4: Missing Bot 2/3 outputs - proceeding anyway");
                            console.warn('[DRBanger] Bot 4 missing previous outputs but proceeding');
                        }
                         if (customPrompts.bot4) {
                            prompt = customPrompts.bot4
                                .replace(/\${bot2Output}/g, bot2Output4 || "[NO BOT 2 OUTPUT]")
                                .replace(/\${bot3Output}/g, bot3Output || "[NO BOT 3 OUTPUT]")
                                .replace(/\${legalText}/g, legalText || "[NO LEGAL TEXT]")
                                .replace(/\${sstTechnique}/g, sstTechnique || "[NO SST]");
                        } else {
                            prompt = botPrompts.bot4(bot2Output4 || "[NO BOT 2 OUTPUT]", bot3Output || "[NO BOT 3 OUTPUT]", legalText || "[NO LEGAL TEXT]", sstTechnique || "[NO SST]", customInstruction);
                        }
                        break;
                        
                    case 5:
                        const bot4Output = document.getElementById('bot4Output').textContent;
                        if (!bot4Output) {
                            showErrorToast("Bot 5: No Bot 4 output available - proceeding anyway");
                            console.warn('[DRBanger] Bot 5 missing Bot 4 output but proceeding');
                        }
                         if (customPrompts.bot5) {
                            prompt = customPrompts.bot5.replace(/\${bot4Output}/g, bot4Output || "[NO BOT 4 OUTPUT]");
                        } else {
                            prompt = botPrompts.bot5(bot4Output || "[NO BOT 4 OUTPUT]", customInstruction);
                        }
                        break;
                        
                    case 6:
                        const conversationHistory = [1, 2, 3, 4, 5].map(i => {
                            const output = document.getElementById(`bot${i}Output`).textContent;
                            return output ? `Bot ${i} Output:\n${output}\n\n` : `Bot ${i} Output: [NO OUTPUT]\n\n`;
                        }).join('');
                        
                        const customDomain = document.getElementById('customDomain').value.trim();
                        const userInstruction = document.getElementById('customInstruction').value.trim();
                        
                        if (customPrompts.bot6) {
                            prompt = customPrompts.bot6
                                .replace(/\${conversationHistory}/g, conversationHistory)
                                .replace(/\${customDomain}/g, customDomain || '[NULL - Select optimal domain based on analysis gaps]')
                                .replace(/\${customInstruction}/g, userInstruction || '[NULL - Use standard generation protocol]');
                        } else {
                            prompt = botPrompts.bot6(conversationHistory, customDomain, userInstruction, customInstruction);
                        }
                        break;
                        
                    default:
                        showErrorToast("Invalid bot number");
                        onBotEnd(botNumber);
                        return;
                }
                
                let inputPreview = "Inputs:\n";
                if (legalText) inputPreview += `Legal Text: ${legalText.substring(0, 100)}${legalText.length > 100 ? '...' : ''}\n`;
                if (sstTechnique) inputPreview += `SST: ${sstTechnique.substring(0, 100)}${sstTechnique.length > 100 ? '...' : ''}\n`;
                if(customInstruction) inputPreview += `Custom Instruction: ${customInstruction.substring(0, 100)}${customInstruction.length > 100 ? '...' : ''}\n`;
                addLogEntry('bot_input', `Bot ${botNumber} Input`, inputPreview);
                
                console.log(`[DRBanger] Bot ${botNumber} executing with prompt length:`, prompt.length);
                
                await window.Poe.sendUserMessage(`@${cleanBotName} ${prompt}`, {
                    handler: `bot${botNumber}-handler`,
                    stream: true,
                    openChat: false
                });
                
            } catch (error) {
                console.error(`[DRBanger] Bot ${botNumber} execution error:`, error);
                showErrorToast(`Bot ${botNumber} error: ${error.message}`);
                updateStepStatus(stepMap[botNumber], 'error');
                resetBotState(botNumber); // PHASE 2A: Use resetBotState instead of onBotEnd for cleanup
                addLogEntry('bot_error', `Bot ${botNumber} Error`, `Execution failed: ${error.message}`);
            }
        }

        // ===== EVENT LISTENERS =====
        
        // Initialize all systems
        setupInputButtons();
        setupBotButtons();
        setupClearButtons();
        setupLegalTextDatabaseControls();
        
        // No longer needed - preview system replaced with logging
        
        // ===== NEW STATE MANAGEMENT FUNCTIONS =====
        
        function downloadStateAsFile() {
            try {
                const state = captureCurrentState();
                const stateJson = JSON.stringify(state, null, 2);
                const timestamp = getFormattedTimestamp();
                const filename = `DRBanger_State_${timestamp}.json`;
                
                const blob = new Blob([stateJson], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log('[DRBanger] State downloaded as file:', filename);
                showStateToast('📥 State downloaded as file');
            } catch (error) {
                console.error('[DRBanger] Error downloading state:', error);
                showErrorToast('Error downloading state');
            }
        }

        function importStateFromClipboard() {
            document.getElementById('loadStateModal').classList.remove('hidden');
            document.getElementById('loadStateTextarea').value = '';
            document.getElementById('loadStateTextarea').placeholder = 'Paste your DRBanger state JSON here...';
        }

        function loadStateFromFile() {
            const fileInput = document.getElementById('stateFileInput');
            fileInput.click();
        }

        // Hidden file input handler for state upload
        document.getElementById('stateFileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/json') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const state = JSON.parse(e.target.result);
                        const success = restoreState(state);
                        
                        if (success) {
                            showStateToast('📁 State loaded from file successfully');
                        } else {
                            showErrorToast('Failed to restore state completely');
                        }
                        
                    } catch (error) {
                        console.error('[DRBanger] Invalid state file:', error);
                        showErrorToast('Invalid JSON format in state file');
                    }
                };
                reader.readAsText(file);
            } else {
                showErrorToast('Please select a valid JSON file');
            }
            
            // Reset file input for future use
            event.target.value = '';
        });

        // State Management Event Listeners - Consolidated
        ['Input', 'Results'].forEach(tab => {
            document.getElementById(`saveState${tab}`).addEventListener('click', saveState);
            document.getElementById(`downloadState${tab}`).addEventListener('click', downloadStateAsFile);
            document.getElementById(`loadState${tab}`).addEventListener('click', loadStateFromFile);
            document.getElementById(`importState${tab}`).addEventListener('click', importStateFromClipboard);
        });
        
        // Modal controls
        document.getElementById('confirmLoadState').addEventListener('click', confirmLoadState);
        document.getElementById('cancelLoadState').addEventListener('click', cancelLoadState);
        
        // Bot execution buttons - Consolidated for both tabs
        for (let i = 1; i <= 6; i++) {
            document.getElementById(`executeBot${i}`).addEventListener('click', () => executeBot(i));
            document.getElementById(`executeBot${i}Results`).addEventListener('click', () => executeBot(i));
        }

        // Bot 6 Panel Execute Button
        document.getElementById('executeBot6Panel').addEventListener('click', () => executeBot(6));

        // Sample random SST button
        document.getElementById('sampleSSTBtn').addEventListener('click', () => {
            const randomSST = getRandomSST();
            if (randomSST) {
                document.getElementById('sstCapsule').value = randomSST;
                console.log('[DRBanger] Random SST sampled:', randomSST);
            } else {
                showErrorToast("No SST database loaded");
            }
        });

        // Download Flow
        document.getElementById('downloadFlow').addEventListener('click', downloadFlow);

        // Download All Responses
        document.getElementById('downloadAllResponses').addEventListener('click', downloadFlow);

        // Legal Text Database System
        let legalTextDatabase = null;

        // ===== BOT PROMPTS DATABASE SYSTEM =====
        let botPromptsDatabase = null;
        let customPrompts = {
            bot1: null,
            bot2: null,
            bot3: null,
            bot4: null,
            bot5: null,
            bot6: null
        };
        // NEW: Storage for per-bot injected instructions
        let injectedInstructions = { 1: null, 2: null, 3: null, 4: null, 5: null, 6: null };

        // Bot Prompts Database file upload handler
        document.getElementById('botPromptsFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/json') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        botPromptsDatabase = data;
                        document.getElementById('botPromptsDatabaseStatus').textContent = `Loaded ${data.length} bot prompts`;
                        document.getElementById('botPromptsDatabaseStatus').className = 'text-green-600 dark:text-green-400';
                        enableBotPromptButtons();
                        console.log('[DRBanger] Bot Prompts Database loaded successfully:', data);
                    } catch (error) {
                        console.error('[DRBanger] Failed to load bot prompts database:', error);
                        showError('Invalid JSON file format');
                        document.getElementById('botPromptsDatabaseStatus').textContent = 'Failed to load database';
                        document.getElementById('botPromptsDatabaseStatus').className = 'text-red-600 dark:text-red-400';
                    }
                };
                reader.readAsText(file);
            }
        });

        function enableBotPromptButtons() {
            for (let i = 1; i <= 6; i++) {
                document.getElementById(`loadBot${i}Prompt`).disabled = false;
                document.getElementById(`randomBot${i}Prompt`).disabled = false;
            }
        }

        function setupBotPromptControls() {
            const promptActions = {
                load: (i, searchId) => {
                    if (!botPromptsDatabase) {
                        showErrorToast('Please load a bot prompts database first');
                        return;
                    }
                    if (!searchId) {
                        showErrorToast('Please enter a prompt ID');
                        return;
                    }
                    
                    const foundPrompt = botPromptsDatabase.find(prompt => prompt.prompt_id === searchId);
                    if (foundPrompt) {
                        customPrompts[`bot${i}`] = foundPrompt.prompt_template;
                        document.getElementById(`bot${i}PromptStatus`).textContent = `${foundPrompt.name} (${searchId})`;
                        document.getElementById(`bot${i}PromptStatus`).className = 'text-xs text-green-600 dark:text-green-400 mt-1';
                        showStateToast(`🎯 Loaded prompt ${searchId} for Bot ${i}`);
                        document.getElementById(`bot${i}PromptSearch`).value = '';
                    } else {
                        showErrorToast(`Prompt ID ${searchId} not found`);
                    }
                },
                random: (i) => {
                    if (!botPromptsDatabase || botPromptsDatabase.length === 0) {
                        showErrorToast('No bot prompts database loaded');
                        return;
                    }
                    
                    const randomPrompt = botPromptsDatabase[Math.floor(Math.random() * botPromptsDatabase.length)];
                    customPrompts[`bot${i}`] = randomPrompt.prompt_template;
                    document.getElementById(`bot${i}PromptStatus`).textContent = `${randomPrompt.name} (${randomPrompt.prompt_id})`;
                    document.getElementById(`bot${i}PromptStatus`).className = 'text-xs text-green-600 dark:text-green-400 mt-1';
                    showStateToast(`🎲 Random prompt ${randomPrompt.prompt_id} for Bot ${i}`);
                }
            };

            for (let i = 1; i <= 6; i++) {
                // Load prompt by ID
                document.getElementById(`loadBot${i}Prompt`).addEventListener('click', () => {
                    const searchId = document.getElementById(`bot${i}PromptSearch`).value.trim();
                    promptActions.load(i, searchId);
                });

                // Random prompt
                document.getElementById(`randomBot${i}Prompt`).addEventListener('click', () => {
                    promptActions.random(i);
                });

                // Allow Enter key on search input
                document.getElementById(`bot${i}PromptSearch`).addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById(`loadBot${i}Prompt`).click();
                    }
                });
            }
        }
        
        function setupInstructionInjection() {
            for (let i = 1; i <= 6; i++) {
                const injectBtn = document.getElementById(`inject-instruction-bot${i}`);
                const clearBtn = document.getElementById(`clear-instruction-bot${i}`);
                const instructionBox = document.getElementById(`bot${i}-custom-instruction`);
                const summary = document.getElementById(`bot${i}-injection-summary`);

                if (!injectBtn) continue; // Skip if element doesn't exist

                // Inject Button
                injectBtn.addEventListener('click', () => {
                    const instruction = instructionBox.value.trim();
                    if (instruction) {
                        injectedInstructions[i] = instruction;
                        summary.innerHTML = '✅ Custom Instruction Injected!';
                        summary.classList.add('text-green-600', 'dark:text-green-400');
                        clearBtn.classList.remove('hidden');
                        showStateToast(`🎯 Instruction injected for Bot ${i}`);
                    } else {
                        showErrorToast('Instruction cannot be empty.');
                    }
                });

                // Clear Button
                clearBtn.addEventListener('click', () => {
                    injectedInstructions[i] = null;
                    instructionBox.value = '';
                    summary.innerHTML = '➕ Add Custom Instruction';
                    summary.classList.remove('text-green-600', 'dark:text-green-400');
                    clearBtn.classList.add('hidden');
                });
            }
        }

        // Legal Text File Upload System (Unified Upload Handler)
        document.getElementById('legalTextFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/json') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        console.log('[DRBanger] Legal text file data:', data);
                        
                        // For legal text inputs, we expect either a single text or an array of inputs
                        if (typeof data === 'string') {
                            document.getElementById('legalText').value = data;
                            showStateToast('📁 Legal text loaded from file');
                        } else if (Array.isArray(data) && data.length > 0) {
                            // Load legal text database for search/randomize functionality
                            legalTextDatabase = data;
                            updateLegalTextDatabaseStatus();
                            showStateToast(`📁 Legal text database loaded (${data.length} entries)`);
                            console.log('[DRBanger] Legal text database loaded:', legalTextDatabase);
                        } else if (data.input_text) {
                            // Single object with input_text field
                            document.getElementById('legalText').value = data.input_text;
                            showStateToast('📁 Legal text loaded from file');
                        } else {
                            showErrorToast('Invalid JSON format for legal text');
                        }
                    } catch (error) {
                        console.error('[DRBanger] Failed to load legal text file:', error);
                        showErrorToast('Invalid JSON file format');
                    }
                };
                reader.readAsText(file);
            } else {
                showErrorToast('Please select a JSON file');
            }
        });

        function updateLegalTextDatabaseStatus() {
            const statusElement = document.getElementById('legalTextDatabaseStatus');
            const loadButton = document.getElementById('loadLegalTextById');
            const randomButton = document.getElementById('randomizeLegalText');
            
            if (legalTextDatabase && legalTextDatabase.length > 0) {
                statusElement.textContent = `${legalTextDatabase.length} legal texts loaded`;
                statusElement.className = 'text-green-600 dark:text-green-400';
                loadButton.disabled = false;
                randomButton.disabled = false;
            } else {
                statusElement.textContent = 'No database loaded';
                statusElement.className = 'text-gray-600 dark:text-gray-400';
                loadButton.disabled = true;
                randomButton.disabled = true;
            }
        }

        // Legal Text Database Controls
        function setupLegalTextDatabaseControls() {
            addManagedEventListener(
                document.getElementById('loadLegalTextById'),
                'click',
                () => {
                    const searchId = parseInt(document.getElementById('legalTextSearch').value);
                    if (!legalTextDatabase) {
                        showErrorToast('Please load a legal text database first');
                        return;
                    }
                    if (!searchId || isNaN(searchId)) {
                        showErrorToast('Please enter a valid ID number');
                        return;
                    }
                    
                    const foundEntry = legalTextDatabase.find(entry => entry.prompt_id === searchId);
                    if (foundEntry) {
                        document.getElementById('legalText').value = foundEntry.input_text;
                        showStateToast(`📖 Loaded legal text ID ${searchId}`);
                        // Clear search box
                        document.getElementById('legalTextSearch').value = '';
                    } else {
                        showErrorToast(`Legal text ID ${searchId} not found`);
                    }
                },
                'Load Legal Text by ID'
            );

            addManagedEventListener(
                document.getElementById('randomizeLegalText'),
                'click',
                () => {
                    if (!legalTextDatabase || legalTextDatabase.length === 0) {
                        showErrorToast('No legal text database loaded');
                        return;
                    }
                    
                    const randomEntry = legalTextDatabase[Math.floor(Math.random() * legalTextDatabase.length)];
                    document.getElementById('legalText').value = randomEntry.input_text;
                    showStateToast(`🎲 Loaded random legal text (ID ${randomEntry.prompt_id})`);
                },
                'Random Legal Text'
            );

            // Allow Enter key on search input
            addManagedEventListener(
                document.getElementById('legalTextSearch'),
                'keypress',
                (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('loadLegalTextById').click();
                    }
                },
                'Legal Text Search Enter Key'
            );
        }

        // ===== MANUAL COMPLETION CHECKBOXES =====
        function setupManualCompletionCheckboxes() {
            for (let i = 1; i <= 6; i++) {
                const checkbox = document.getElementById(`manualCompleteBot${i}`);
                if (checkbox) {
                    checkbox.addEventListener('change', () => {
                        const stepMap = { 1: 'step1Status', 2: 'step2Status', 3: 'step3Status', 4: 'step4Status', 5: 'step5Status', 6: 'step6Status' };
                        
                        if (checkbox.checked) {
                            // Mark as complete
                            updateStepStatus(stepMap[i], 'complete');
                            document.getElementById(`bot${i}Status`).textContent = "✅ Manually marked complete";
                            document.getElementById(`bot${i}Status`).className = 'text-sm text-green-600 dark:text-green-400 mb-2';
                            
                            // Log manual completion
                            addLogEntry('manual_complete', `Bot ${i} Manual Completion`, `User manually marked Bot ${i} as complete`);
                            
                            // Advance floating button workflow if this is the current bot
                            if (currentWorkflowBot === i) {
                                onBotComplete(i);
                            }
                            
                            console.log(`[DRBanger] Bot ${i} manually marked as complete`);
                        } else {
                            // Uncheck - reset to idle
                            updateStepStatus(stepMap[i], 'idle');
                            document.getElementById(`bot${i}Status`).textContent = "";
                            addLogEntry('manual_complete', `Bot ${i} Manual Reset`, `User unmarked Bot ${i} completion`);
                            console.log(`[DRBanger] Bot ${i} manual completion reset`);
                        }
                    });
                }
            }
        }

        // ===== LIVE LOGGING ENHANCEMENTS =====
        
        // Logging toggle functionality
        document.getElementById('loggingToggle').addEventListener('click', (e) => {
            // Don't toggle if clicking on controls
            if (e.target.closest('.flex.items-center.space-x-3')) return;
            
            const content = document.getElementById('loggingContent');
            const arrow = document.getElementById('loggingArrow');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                arrow.textContent = '▼';
            } else {
                content.classList.add('hidden');
                arrow.textContent = '▶';
            }
        });

        // Logging control event listeners
        document.getElementById('loggingFont').addEventListener('change', function() {
            loggingSettings.font = this.value;
            applyLoggingSettings();
        });

        document.getElementById('loggingSize').addEventListener('change', function() {
            loggingSettings.size = this.value;
            applyLoggingSettings();
        });

        document.getElementById('clearAllLogs').addEventListener('click', clearAllLogs);

        // ===== LOG EXPAND FUNCTIONALITY =====
        window.toggleLogExpand = function(entryId) {
            const preview = document.getElementById(`${entryId}-preview`);
            const full = document.getElementById(`${entryId}-full`);
            const expandBtn = document.querySelector(`button[onclick="toggleLogExpand('${entryId}')"]`);
            
            if (preview && full && expandBtn) {
                if (full.classList.contains('hidden')) {
                    // Expand
                    preview.classList.add('hidden');
                    full.classList.remove('hidden');
                    expandBtn.textContent = 'collapse';
                } else {
                    // Collapse
                    full.classList.add('hidden');
                    preview.classList.remove('hidden');
                    expandBtn.textContent = 'expand';
                }
            }
        };

        // ===== SAFE INITIALIZATION WITH ERROR CHECKING =====
        function safeInitialize() {
            try {
                console.log(`[DRBanger] Starting safe initialization (attempt #${initializationCount + 1})...`);
                
                // Cleanup previous initialization if this is a re-run
                if (initializationCount > 0) {
                    console.log('[DRBanger] Re-initialization detected - cleaning up previous listeners');
                    const cleanedCount = cleanupManagedListeners();
                    console.log(`[DRBanger] Cleaned ${cleanedCount} previous listeners before re-initialization`);
                }
                
                // Increment initialization counter for unique tracking
                initializationCount++;
                
                // Check for essential elements before proceeding
                const essentialElements = [
                    'legalText', 'sstCapsule', 'nextBotButton', 'loggingContent',
                    'bot1Output', 'bot2Output', 'bot3Output', 'bot4Output', 'bot5Output', 'bot6Output'
                ];
                
                for (const elementId of essentialElements) {
                    if (!document.getElementById(elementId)) {
                        console.error(`[DRBanger] Missing essential element: ${elementId}`);
                        showErrorToast(`System initialization failed: Missing ${elementId}`);
                        return;
                    }
                }
                
                // Safe initialization with error handling and managed event listeners
                safeCallWithManagement('setupInputButtons', setupInputButtons);
                safeCallWithManagement('setupBotButtons', setupBotButtons);
                safeCallWithManagement('setupClearButtons', setupClearButtons);
                safeCallWithManagement('setupLegalTextDatabaseControls', setupLegalTextDatabaseControls);
                safeCallWithManagement('setupManualCompletionCheckboxes', setupManualCompletionCheckboxes);
                safeCallWithManagement('setupBotPromptControls', setupBotPromptControls);
                safeCallWithManagement('setupInstructionInjection', setupInstructionInjection);
                safeCallWithManagement('setupResetButtons', setupResetButtons);
                
                // Generate memory usage report
                const memoryReport = getMemoryUsageReport();
                console.log(`[DRBanger] Safe initialization completed successfully:`, memoryReport);
                
            } catch (error) {
                console.error('[DRBanger] Critical initialization error:', error);
                showErrorToast('System initialization failed - check console');
            }
        }
        
        function safeCallWithManagement(functionName, func) {
            try {
                func();
                console.log(`[DRBanger] ${functionName} initialized successfully (init #${initializationCount})`);
            } catch (error) {
                console.error(`[DRBanger] Error in ${functionName}:`, error);
                showErrorToast(`${functionName} failed to initialize`);
            }
        }
        
        // Add cleanup function to global scope for debugging
        window.DRBangerCleanup = {
            cleanupListeners: cleanupManagedListeners,
            getMemoryReport: getMemoryUsageReport,
            reinitialize: safeInitialize
        };
        
        function safeCall(functionName, func) {
            try {
                func();
                console.log(`[DRBanger] ${functionName} initialized successfully`);
            } catch (error) {
                console.error(`[DRBanger] Error in ${functionName}:`, error);
                showErrorToast(`${functionName} failed to initialize`);
            }
        }
        
        // Initialize all systems safely
        safeInitialize();
        
        // Floating Next Bot Button
        document.getElementById('nextBotButton').addEventListener('click', advanceWorkflow);
        
        // Initialize floating button
        updateFloatingButton();
        
        // ===== INITIALIZE ACCORDION MODEL SELECTORS =====
        const botSelectors = [];
        for (let i = 1; i <= 6; i++) {
            const selector = new AccordionModelSelector(`bot${i}`);
            botSelectors.push(selector);
            console.log(`[DRBanger] Initialized accordion selector for bot${i}`);
        }

        // ===== GLOBAL ACCORDION FUNCTIONS =====
        window.toggleBotAccordion = function(botId) {
            const selector = botSelectors.find(s => s.botId === botId);
            if (selector) {
                if (selector.isCollapsed) {
                    selector.expand();
                    // Focus the search box immediately for typing
                    if (selector.searchInput) selector.searchInput.focus();
                } else {
                    selector.collapse();
                }
            }
        };

        window.clearBotSelection = function(event, botId) {
            event.stopPropagation();
            const selector = botSelectors.find(s => s.botId === botId);
            if (selector) {
                selector.clearSelection();
            }
        };

        // ===== TAB SWITCHING FUNCTIONALITY =====
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(`tab-content-${tabName}`).classList.add('active');
            
            // Add active class to selected tab button
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            console.log(`[DRBanger] Switched to tab: ${tabName}`);
        }

        // Tab button event listeners
        document.getElementById('tab-input').addEventListener('click', () => switchTab('input'));
        document.getElementById('tab-results').addEventListener('click', () => switchTab('results'));

        console.log('[DRBanger] Enhanced Bot Prompts System loaded successfully');
        console.log('[DRBanger] Floating Next Bot system initialized');
        console.log('[DRBanger] Manual completion checkboxes initialized');
        console.log('[DRBanger] Live logging system activated');
        console.log('[DRBanger] 6 Accordion Model Selectors initialized with defaults');
        console.log('[DRBanger] Tab switching system initialized');
    </script>
</body>
</html>
